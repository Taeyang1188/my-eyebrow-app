<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>çœ‰ì™„ì„±: ë‚´ ì¸ìƒ ëˆˆì¹ ì°¾ê¸°</title>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <style>
        :root {
            --primary-color: #6a5acd; /* SlateBlue */
            --secondary-color: #f0e6ff;
            --text-color: #333;
            --bg-color: #f8f9fa;
            --container-bg: #ffffff;
            --border-radius: 16px;
            --shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            box-sizing: border-box;
            color: var(--text-color);
        }
        .main-container {
            width: 100%;
            max-width: 500px;
            background-color: var(--container-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 25px;
            box-sizing: border-box;
            text-align: center;
        }
        h1, h2, h3, h4 {
            margin: 0 0 15px;
            color: var(--primary-color);
        }
        h1 { font-size: 2rem; }
        h2 { font-size: 1.6rem; }
        h4 { font-size: 1.1rem; margin-top: 20px;}
        p { line-height: 1.7; margin: 0 0 20px; }
        .btn {
            display: block; width: 100%; padding: 15px; margin: 10px 0;
            border: none; border-radius: 12px; background-color: var(--primary-color);
            color: white; font-size: 1.1rem; font-weight: bold; cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
        }
        .btn:hover { background-color: #5a4ab9; }
        .btn:active { transform: scale(0.98); }
        .btn.secondary {
             background-color: #e9ecef; color: var(--text-color);
        }
        #photo-page .btn.secondary {
            display: inline-block;
            width: auto;
            padding: 15px 30px;
        }
        .btn.secondary:hover { background-color: #d3d9df; }
        .page { display: none; }
        .page.active { display: block; }
        #guide-container {
            width: 100%; aspect-ratio: 3 / 4; background-color: #e9ecef;
            border: 2px dashed #ced4da; border-radius: 12px;
            position: relative; overflow: hidden; user-select: none; margin: 20px 0;
        }
        #user-image, #overlay-canvas, #guideline-svg {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%); /* ì´ë¯¸ì§€ë¥¼ ì¤‘ì•™ì— ë°°ì¹˜í•˜ëŠ” ê¸°ì¤€ */
            max-width: 100%; max-height: 100%;
            height: auto; width: 80%; /* ì´ˆê¸° ë„ˆë¹„ */
        }
        #user-image { z-index: 10; cursor: grab; }
        #user-image:active { cursor: grabbing; }
        #guideline-svg { z-index: 20; pointer-events: none; }
        #overlay-canvas { z-index: 30; pointer-events: none; }
        #guideline-svg .draggable-line {
            pointer-events: all;
            cursor: ns-resize;
            stroke-width: 8px;
            stroke: rgba(0,0,0,0);
        }
        .sliders {
            margin-top: 20px; padding: 20px;
            background-color: #f8f9fa; border-radius: 8px;
        }
        .slider-group {
            display: flex; align-items: center;
            gap: 15px; margin-bottom: 15px;
        }
        .slider-group label { font-size: 14px; width: 100px; text-align: left;}
        input[type="range"] { flex-grow: 1; }
        .description-text {
            font-size: 0.8em; color: #888; text-align: left;
            padding-left: 10px; border-left: 3px solid #e0e0e0;
        }
        .question { margin-bottom: 30px; text-align: left; }
        .question p { font-weight: 500; margin-bottom: 15px; }
        .options { display: flex; flex-direction: column; gap: 10px; }
        .result-card {
            background-color: var(--secondary-color); border-radius: 12px;
            padding: 20px; margin-bottom: 15px; text-align: left;
        }
        .result-card h3 { color: var(--primary-color); border-bottom: 2px solid var(--primary-color); padding-bottom: 10px; margin-bottom: 15px;}
        .result-card ul { padding-left: 20px; margin: 0; list-style-type: none;}
        .result-card li { margin-bottom: 12px; }
        .photo-basis {
            font-size: 0.8em;
            color: #666;
            display: block;
            padding-left: 10px;
            border-left: 2px solid var(--primary-color);
            margin-top: 5px;
        }
        #loader {
            border: 8px solid #f3f3f3; border-radius: 50%;
            border-top: 8px solid var(--primary-color);
            width: 60px; height: 60px;
            animation: spin 1s linear infinite; margin: 30px auto; display: none;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div class="main-container">

        <div id="start-page" class="page active">
            <h1>çœ‰ì™„ì„±</h1>
            <p><strong>ë‚´ ì–¼êµ´ì— ë”± ë§ëŠ” ì¸ìƒ ëˆˆì¹ì„ ì°¾ì•„ë³´ì„¸ìš”!</strong><br>ë‘ ê°€ì§€ ë°©ë²• ì¤‘ í•˜ë‚˜ë¥¼ ì„ íƒí•´ ì§„ë‹¨ì„ ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
            <button class="btn" onclick="showPage('photo-page')">ğŸ“¸ ì‚¬ì§„ìœ¼ë¡œ ë¶„ì„í•˜ê¸°</button>
            <button class="btn" onclick="showPage('quiz-page')">âœï¸ ì„¤ë¬¸ìœ¼ë¡œ ì§„ë‹¨í•˜ê¸°</button>
            <p style="font-size: 0.8em; color: #888; margin-top: 20px;">
                ì‚¬ì§„ì€ ì„œë²„ì— ì €ì¥ë˜ì§€ ì•Šìœ¼ë©°, ë¶„ì„ì€ ëª¨ë‘ ì‚¬ìš©ìì˜ ê¸°ê¸°ì—ì„œë§Œ ì´ë£¨ì–´ì§‘ë‹ˆë‹¤.
            </p>
        </div>

        <div id="photo-page" class="page">
            <h2>ì‚¬ì§„ìœ¼ë¡œ ë¶„ì„í•˜ê¸°</h2>
            <p>ì •ë©´ì„ ë°”ë¼ë³´ëŠ” ì„ ëª…í•œ ì‚¬ì§„ì„ ì˜¬ë¦¬ê³ <br>ê°€ì´ë“œë¼ì¸ì— ë§ì¶° ì–¼êµ´ì„ ì¡°ì •í•´ì£¼ì„¸ìš”.</p>
            
            <label for="file-input" class="btn secondary">ğŸ–¼ï¸ ì‚¬ì§„ ì„ íƒ</label>
            <input type="file" id="file-input" accept="image/*" style="display:none;">

            <div id="guide-container">
                <svg id="guideline-svg" viewbox="0 0 300 400" preserveAspectRatio="xMidYMid meet">
                    <ellipse id="oval-guide" cx="150" cy="200" rx="100" ry="130" stroke="rgba(0,0,0,0.5)" stroke-width="2" stroke-dasharray="5,5" fill="none" />
                    <line id="red-line" x1="50" y1="200" x2="250" y2="200" stroke="red" stroke-width="1.5" />
                    <line id="blue-line" x1="150" y1="70" x2="150" y2="330" stroke="blue" stroke-width="1.5" />
                    <line class="green-line" x1="116.67" y1="70" x2="116.67" y2="330" stroke="green" stroke-width="1" />
                    <line class="green-line" x1="183.33" y1="70" x2="183.33" y2="330" stroke="green" stroke-width="1" />
                    <line id="draggable-line-visual" x1="50" y1="220" x2="250" y2="220" stroke="skyblue" stroke-width="2" />
                    <line class="draggable-line" id="draggable-line-handle" x1="50" y1="220" x2="250" y2="220" />
                </svg>
                <img id="user-image" src="" alt="User's face" style="display:none;">
                <canvas id="overlay-canvas"></canvas>
            </div>

            <div id="photo-controls" style="display:none;">
                <div class="sliders">
                    <p class="description-text"><strong>ì‚¬ì§„ ì¡°ì ˆ</strong></p>
                    <div class="slider-group">
                        <label for="size-slider">ì‚¬ì§„ í¬ê¸°</label>
                        <input type="range" id="size-slider" min="10" max="250" value="80">
                    </div>
                    <div class="slider-group">
                        <label for="opacity-slider">ì‚¬ì§„ íˆ¬ëª…ë„</label>
                        <input type="range" id="opacity-slider" min="0" max="1" step="0.05" value="0.7">
                    </div>
                </div>
                <div class="sliders">
                    <p class="description-text"><strong>ê°€ì´ë“œë¼ì¸ ì¡°ì ˆ</strong></p>
                    <div class="slider-group">
                        <label for="guideline-size-slider">ì „ì²´ í¬ê¸°</label>
                        <input type="range" id="guideline-size-slider" min="50" max="150" value="100">
                    </div>
                    <p class="description-text" style="font-size:0.75em; margin-top: 5px;">
                        ê°€ì´ë“œë¼ì¸ì„ ì¡°ì ˆí•˜ì—¬ ì–¼êµ´ ë¹„ìœ¨ì„ ì§ì ‘ í™•ì¸í•´ë³´ì„¸ìš”.
                    </p>
                </div>
            </div>
            
            <p class="description-text" style="margin-top:15px; font-size: 0.9em;">
                <strong>ë™ê·¸ë€ ì–¼êµ´:</strong> ì–¼êµ´ì˜ ê°€ë¡œì™€ ì„¸ë¡œ ê¸¸ì´ê°€ 1:1.1 ì •ë„ë¡œ ë¹„ìŠ·<br>
                <strong>íƒ€ì›í˜• ì–¼êµ´:</strong> ê°€ë¡œë³´ë‹¤ ì„¸ë¡œ ê¸¸ì´ê°€ 1:1.4 ì´ìƒìœ¼ë¡œ í›¨ì”¬ ê¹€
            </p>
            
            <div id="loader"></div>
            <button class="btn" id="analyze-btn" onclick="analyzePhoto()" style="display:none;">ê²°ê³¼ ë¶„ì„í•˜ê¸°</button>
            <button class="btn secondary" onclick="showPage('start-page')">ë’¤ë¡œ ê°€ê¸°</button>
        </div>

        <div id="quiz-page" class="page">
            <h2>ì„¤ë¬¸ìœ¼ë¡œ ì§„ë‹¨í•˜ê¸°</h2>
            <p>ì•„ë˜ ì§ˆë¬¸ì— ë‹µí•˜ì—¬<br>ìì‹ ì—ê²Œ ê¼­ ë§ëŠ” ëˆˆì¹ ìŠ¤íƒ€ì¼ì„ ì°¾ì•„ë³´ì„¸ìš”.</p>
            <form id="quiz-form">
                <div class="question">
                    <p>1. ë‚´ ì–¼êµ´ì˜ íŠ¹ì§•ì€ ì–´ë””ì— ê°€ê¹ë‚˜ìš”?</p>
                    <div class="options">
                        <label><input type="radio" name="q1" value="A"> ì–¼êµ´ì´ ê¸¸ê±°ë‚˜, ëˆˆê³¼ ëˆˆì¹ ì‚¬ì´ê°€ ë©€ë‹¤.</label>
                        <label><input type="radio" name="q1" value="B"> ì–¼êµ´ì´ ì§§ê±°ë‚˜, ëˆˆê³¼ ëˆˆì¹ ì‚¬ì´ê°€ ì¢ë‹¤.</label>
                    </div>
                </div>
                <div class="question">
                    <p>2. ë‚˜ì˜ ì „ì²´ì ì¸ ì¸ìƒì´ë‚˜ ì–¼êµ´ ë¼ì¸ì€?</p>
                    <div class="options">
                        <label><input type="radio" name="q2" value="C"> ì–¼êµ´ì„ ì´ ë‘¥ê¸€ê³ , ì²­ìˆœí•˜ê³  ë¶€ë“œëŸ¬ìš´ ì¸ìƒì´ë‹¤.</label>
                        <label><input type="radio" name="q2" value="D"> ì–¼êµ´ì„ ì´ ê°ì§€ê³ , ì„¸ë ¨ë˜ê³  ë˜ë ·í•œ ì¸ìƒì´ë‹¤.</label>
                    </div>
                </div>
                <div class="question">
                    <p>3. ë‚´ ëˆˆ ëª¨ì–‘ì€ ì–´ë–¤ê°€ìš”?</p>
                    <div class="options">
                        <label><input type="radio" name="q3" value="E"> ëˆˆì´ ì „ì²´ì ìœ¼ë¡œ ë™ê·¸ë€ í¸ì´ë‹¤.</label>
                        <label><input type="radio" name="q3" value="F"> ëˆˆì´ ê°€ë¡œë¡œ ê¸´ í¸ì´ë‹¤.</label>
                    </div>
                </div>
                <div class="question">
                    <p>4. ë‚´ ì´ëª©êµ¬ë¹„ëŠ” ì–¼êµ´ ì¤‘ì•™ì— ëª¨ì—¬ìˆëŠ” í¸ì¸ê°€ìš”?</p>
                    <div class="options">
                        <label><input type="radio" name="q4" value="A"> ì´ëª©êµ¬ë¹„ê°€ ì¤‘ì•™ì— ëª¨ì—¬ìˆê³ , ëˆˆ ì‚¬ì´ê°€ ê°€ê¹ë‹¤ (ë‚´ì‹¬ì•ˆ).</label>
                        <label><input type="radio" name="q4" value="B"> ì´ëª©êµ¬ë¹„ê°€ ë„“ê²Œ í¼ì ¸ìˆê³ , ëˆˆ ì‚¬ì´ê°€ ë©€ë‹¤ (ì™¸ì‹¬ì•ˆ).</label>
                    </div>
                </div>
                <div class="question">
                    <p>5. ë‚´ ì–¼êµ´ì˜ ê°€ë¡œ/ì„¸ë¡œ ë¹„ìœ¨ì€ ì–´ë–¤ê°€ìš”?</p>
                    <div class="options">
                        <label><input type="radio" name="q5" value="C"> ê°€ë¡œ ëŒ€ë¹„ ì„¸ë¡œ ê¸¸ì´ê°€ ì§§ì€ ë™ê·¸ë€ ì–¼êµ´í˜•ì´ë‹¤.</label>
                        <label><input type="radio" name="q5" value="D"> ê°€ë¡œ ëŒ€ë¹„ ì„¸ë¡œ ê¸¸ì´ê°€ ê¸´ íƒ€ì›í˜•/ê¸´ ì–¼êµ´í˜•ì´ë‹¤.</label>
                    </div>
                </div>
                <div class="question">
                    <p>6. ë‚˜ì˜ ë¯¸ê°„ ë„ˆë¹„ì™€ ì¶”êµ¬í•˜ëŠ” ì¸ìƒì€?</p>
                    <div class="options">
                        <label><input type="radio" name="q6" value="E"> ë¯¸ê°„ì´ ì¢ì€ í¸ì´ë©°, ë¶€ë“œëŸ¬ìš´ ì¸ìƒì„ ì›í•œë‹¤.</label>
                        <label><input type="radio" name="q6" value="F"> ë¯¸ê°„ì´ ë„“ì€ í¸ì´ë©°, ë˜ë ·í•œ ì¸ìƒì„ ì›í•œë‹¤.</label>
                    </div>
                </div>
                <button type="button" class="btn" onclick="analyzeQuiz()">ê²°ê³¼ í™•ì¸í•˜ê¸°</button>
                <button type="button" class="btn secondary" onclick="showPage('start-page')">ë’¤ë¡œ ê°€ê¸°</button>
            </form>
        </div>

        <div id="result-page" class="page">
            <h2>ì§„ë‹¨ ê²°ê³¼ ğŸ§</h2>
            <p>ë‹¹ì‹ ì—ê²Œ ì–´ìš¸ë¦¬ëŠ” ìµœê³ ì˜ ëˆˆì¹ ìŠ¤íƒ€ì¼ì„ ì¶”ì²œí•©ë‹ˆë‹¤!</p>
            <div id="result-content"></div>
            <button class="btn" onclick="showPage('start-page')">ë‹¤ì‹œ í•˜ê¸°</button>
        </div>
        
    </div>

<script>
    const pages = document.querySelectorAll('.page');
    const loader = document.getElementById('loader');
    let modelsLoaded = false;

    // í˜ì´ì§€ ì „í™˜ í•¨ìˆ˜
    function showPage(pageId) {
        pages.forEach(page => page.classList.remove('active'));
        const targetPage = document.getElementById(pageId);
        if (targetPage) {
            targetPage.classList.add('active');
        }
        // ì‹œì‘ í˜ì´ì§€ë¡œ ëŒì•„ì˜¬ ë•Œ ì´ì „ ìƒíƒœ ì´ˆê¸°í™”
        if (pageId === 'start-page') {
            const fileInput = document.getElementById('file-input');
            const userImage = document.getElementById('user-image');
            const photoControls = document.getElementById('photo-controls');
            const analyzeBtn = document.getElementById('analyze-btn');
            const canvas = document.getElementById('overlay-canvas');
            if(fileInput) fileInput.value = '';
            if(userImage) { userImage.src = ''; userImage.style.display = 'none'; }
            if(photoControls) photoControls.style.display = 'none';
            if(analyzeBtn) analyzeBtn.style.display = 'none';
            if(canvas) { canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height); }
            const quizForm = document.getElementById('quiz-form');
            if(quizForm) quizForm.reset(); // í€´ì¦ˆ í¼ ì´ˆê¸°í™”
        }
    }

    // Face-api.js ëª¨ë¸ ë¡œë“œ í•¨ìˆ˜
    async function loadModels() {
        // ëª¨ë¸ íŒŒì¼ë“¤ì´ ìœ„ì¹˜í•œ ê²½ë¡œ. `index.html`ê³¼ ê°™ì€ ë ˆë²¨ì˜ `models` í´ë”ì— ìˆì–´ì•¼ í•©ë‹ˆë‹¤.
        const MODEL_URL = './models'; 
        try {
            await faceapi.nets.ssdMobilenetv1.loadFromUri(MODEL_URL); // ì–¼êµ´ ê°ì§€ ëª¨ë¸
            await faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL); // ì–¼êµ´ ëœë“œë§ˆí¬ ëª¨ë¸
            await faceapi.nets.ageGenderNet.loadFromUri(MODEL_URL); // ì„±ë³„/ë‚˜ì´ ì¸ì‹ ëª¨ë¸ (ì´ íŒŒì¼ì´ models í´ë”ì— ìˆëŠ”ì§€ í™•ì¸ í•„ìˆ˜!)
            modelsLoaded = true;
            console.log("ëª¨ë¸ ë¡œë”© ì™„ë£Œ!");
        } catch (error) {
            console.error("ëª¨ë¸ ë¡œë”© ì‹¤íŒ¨:", error);
            alert("ë¶„ì„ ëª¨ë¸ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. (ê²½ë¡œ í™•ì¸: " + MODEL_URL + ") \n\n" + 
                  "ë‹¤ìŒ ì‚¬í•­ì„ í™•ì¸í•´ì£¼ì„¸ìš”:\n" +
                  "1. 'models' í´ë”ê°€ HTML íŒŒì¼ê³¼ ê°™ì€ ìœ„ì¹˜ì— ìˆëŠ”ì§€.\n" +
                  "2. 'models' í´ë” ì•ˆì— 'ssd_mobilenetv1_model.weights', 'face_landmark_68_model.weights', 'age_gender_model.weights' ë“± ëª¨ë“  í•„ìš”í•œ .weights íŒŒì¼ì´ ìˆëŠ”ì§€.\n" +
                  "3. HTML íŒŒì¼ì„ ë¸Œë¼ìš°ì €ì—ì„œ 'file:///' ê²½ë¡œë¡œ ì§ì ‘ ì—´ì§€ ì•Šê³ , íŒŒì´ì¬ 'http.server'ë‚˜ 'http-server' ê°™ì€ ë¡œì»¬ ì›¹ ì„œë²„ë¥¼ í†µí•´ 'http://localhost:í¬íŠ¸ë²ˆí˜¸'ë¡œ ì ‘ì†í–ˆëŠ”ì§€.");
        }
    }
    loadModels(); // ì•± ì‹œì‘ ì‹œ ëª¨ë¸ ë¡œë“œ ì‹œë„

    // DOM ìš”ì†Œ ìºì‹±
    const fileInput = document.getElementById('file-input');
    const userImage = document.getElementById('user-image');
    const photoControls = document.getElementById('photo-controls');
    const analyzeBtn = document.getElementById('analyze-btn');
    const guideContainer = document.getElementById('guide-container');

    // íŒŒì¼ ì…ë ¥ ë³€ê²½ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    if (fileInput) {
        fileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;
            // ìº”ë²„ìŠ¤ ì´ˆê¸°í™”
            document.getElementById('overlay-canvas').getContext('2d').clearRect(0,0,300,400);
            const reader = new FileReader();
            reader.onload = (e) => {
                userImage.src = e.target.result;
                userImage.style.display = 'block';
                if(photoControls) photoControls.style.display = 'block';
                if(analyzeBtn) analyzeBtn.style.display = 'block';
                // ì´ë¯¸ì§€ ë° ê°€ì´ë“œë¼ì¸ ì´ˆê¸° ìƒíƒœ ì„¤ì •
                document.getElementById('size-slider').value = 80;
                userImage.style.width = '80%';
                userImage.style.left = '50%';
                userImage.style.top = '50%';
                userImage.style.transform = 'translate(-50%, -50%)'; // ì´ˆê¸° transform ìœ ì§€
                document.getElementById('opacity-slider').value = 0.7;
                userImage.style.opacity = '0.7';
                document.getElementById('guideline-size-slider').value = 100;
                updateGuidelineSize(100);
            };
            reader.readAsDataURL(file);
        });
    }

    // ìŠ¬ë¼ì´ë” ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    const sizeSlider = document.getElementById('size-slider');
    const opacitySlider = document.getElementById('opacity-slider');
    if (sizeSlider) {
        sizeSlider.addEventListener('input', (e) => { 
            if(userImage) userImage.style.width = `${e.target.value}%`; 
            // ì´ë¯¸ì§€ í¬ê¸° ë³€ê²½ ì‹œ ìœ„ì¹˜ ì¬ì¡°ì • (ì¤‘ì•™ ìœ ì§€)
            // userImage.style.left = '50%'; 
            // userImage.style.top = '50%'; 
            // userImage.style.transform = 'translate(-50%, -50%)';
        });
    }
    if (opacitySlider) {
        opacitySlider.addEventListener('input', (e) => { if(userImage) userImage.style.opacity = e.target.value; });
    }
    
    // ê°€ì´ë“œë¼ì¸ ê´€ë ¨ DOM ìš”ì†Œ ë° ìƒìˆ˜
    const guidelineSVG = document.getElementById('guideline-svg');
    const ovalGuide = document.getElementById('oval-guide');
    const redLine = document.getElementById('red-line');
    const blueLine = document.getElementById('blue-line');
    const greenLines = guidelineSVG.querySelectorAll('.green-line');
    const draggableLineVisual = document.getElementById('draggable-line-visual');
    const draggableLineHandle = document.getElementById('draggable-line-handle');
    const guidelineSizeSlider = document.getElementById('guideline-size-slider');
    const IDEAL_ASPECT_RATIO = 1.3; // ê°€ì´ë“œë¼ì¸ íƒ€ì›ì˜ ì„¸ë¡œ/ê°€ë¡œ ë¹„ìœ¨

    // ê°€ì´ë“œë¼ì¸ í¬ê¸° ì—…ë°ì´íŠ¸ í•¨ìˆ˜
    function updateGuidelineSize(sizePercent) {
        const svgWidth = 300;
        const baseRx = svgWidth / 3; 
        const rx = baseRx * (sizePercent / 100); // ê°€ì´ë“œë¼ì¸ ê°€ë¡œ ë°˜ì§€ë¦„
        const ry = rx * IDEAL_ASPECT_RATIO; // ê°€ì´ë“œë¼ì¸ ì„¸ë¡œ ë°˜ì§€ë¦„

        ovalGuide.setAttribute('rx', rx);
        ovalGuide.setAttribute('ry', ry);
        
        redLine.setAttribute('x1', 150 - rx);
        redLine.setAttribute('x2', 150 + rx);
        blueLine.setAttribute('y1', 200 - ry);
        blueLine.setAttribute('y2', 200 + ry);
        
        const sectionWidth = (rx * 2) / 3;
        const startX = 150 - rx;
        greenLines[0].setAttribute('x1', startX + sectionWidth);
        greenLines[0].setAttribute('x2', startX + sectionWidth);
        greenLines[0].setAttribute('y1', 200 - ry);
        greenLines[0].setAttribute('y2', 200 + ry);
        
        greenLines[1].setAttribute('x1', startX + (sectionWidth * 2));
        greenLines[1].setAttribute('x2', startX + (sectionWidth * 2));
        greenLines[1].setAttribute('y1', 200 - ry);
        greenLines[1].setAttribute('y2', 200 + ry);

        draggableLineVisual.setAttribute('x1', 150 - rx);
        draggableLineVisual.setAttribute('x2', 150 + rx);
        draggableLineHandle.setAttribute('x1', 150 - rx);
        draggableLineHandle.setAttribute('x2', 150 + rx);
    }

    // ê°€ì´ë“œë¼ì¸ í¬ê¸° ìŠ¬ë¼ì´ë” ì´ë²¤íŠ¸
    if(guidelineSizeSlider) {
        guidelineSizeSlider.addEventListener('input', (e) => {
            updateGuidelineSize(e.target.value);
        });
    }
    updateGuidelineSize(100); // ì´ˆê¸° ê°€ì´ë“œë¼ì¸ í¬ê¸° ì„¤ì •
    
    // ì´ë¯¸ì§€ ë° ë“œë˜ê·¸ë¼ì¸ ë“œë˜ê·¸ ê´€ë ¨ ë³€ìˆ˜
    let isImageDragging = false;
    let isLineDragging = false;
    let startX_drag, startY_drag; // ë§ˆìš°ìŠ¤ ì‹œì‘ ìœ„ì¹˜ (í´ë¼ì´ì–¸íŠ¸ ì¢Œí‘œ)
    let initialImageX, initialImageY; // ì´ë¯¸ì§€ì˜ ì´ˆê¸° transform.translate ê°’
    let initialLineY; // ë“œë˜ê·¸ ê°€ëŠ¥í•œ ì„ ì˜ ì´ˆê¸° Y ìœ„ì¹˜ (SVG ì¢Œí‘œ)
    
    // ë“œë˜ê·¸ ì‹œì‘ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ (mousedown)
    if (guideContainer) {
        guideContainer.addEventListener('mousedown', e => {
            if (e.target.id === 'draggable-line-handle') { // ë“œë˜ê·¸ ê°€ëŠ¥í•œ ì„ ì„ í´ë¦­í–ˆì„ ë•Œ
                isLineDragging = true;
                initialLineY = parseFloat(draggableLineVisual.getAttribute('y1'));
                const CTM = guidelineSVG.getScreenCTM().inverse(); // SVG-to-screen ë³€í™˜ í–‰ë ¬ì˜ ì—­í–‰ë ¬
                const pt = guidelineSVG.createSVGPoint();
                pt.x = e.clientX;
                pt.y = e.clientY;
                startY_drag = pt.matrixTransform(CTM).y; // SVG ì¢Œí‘œê³„ì—ì„œì˜ Y ì‹œì‘ì 
                return;
            }
            if (!userImage.src || userImage.style.display === 'none') return; // ì´ë¯¸ì§€ê°€ ì—†ìœ¼ë©´ ë“œë˜ê·¸ ì•ˆí•¨
            e.preventDefault(); // ê¸°ë³¸ ë“œë˜ê·¸ ë™ì‘ ë°©ì§€
            isImageDragging = true;
            userImage.style.cursor = 'grabbing';
            startX_drag = e.clientX;
            startY_drag = e.clientY;

            // í˜„ì¬ ì´ë¯¸ì§€ì˜ transform ì†ì„±ì—ì„œ translateX, translateY ê°’ì„ ê°€ì ¸ì˜´
            const transform = window.getComputedStyle(userImage).transform;
            const matrix = new DOMMatrix(transform);
            initialImageX = matrix.m41;
            initialImageY = matrix.m42;
        });
    }

    // ë“œë˜ê·¸ ì¤‘ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ (mousemove)
    window.addEventListener('mousemove', (e) => {
        if (isLineDragging && guidelineSVG) { // ì„  ë“œë˜ê·¸ ë¡œì§
            const CTM = guidelineSVG.getScreenCTM().inverse();
            const pt = guidelineSVG.createSVGPoint();
            pt.x = e.clientX;
            pt.y = e.clientY;
            const svgP = pt.matrixTransform(CTM); // í˜„ì¬ ë§ˆìš°ìŠ¤ì˜ SVG ì¢Œí‘œ

            // ë“œë˜ê·¸ ê°€ëŠ¥í•œ ì„ ì˜ ì´ë™ ë²”ìœ„ ì œí•œ
            // ê°€ì´ë“œë¼ì¸ íƒ€ì›ì˜ ì„¸ë¡œ ë°˜ì§€ë¦„ (ry)ì„ ì´ìš©í•˜ì—¬ ìƒí•˜ ì´ë™ ë²”ìœ„ë¥¼ ì„¤ì •
            const ovalRy = parseFloat(ovalGuide.getAttribute('ry'));
            const minY = 200 - ovalRy; // SVG ì¢Œí‘œê³„ì—ì„œ íƒ€ì› ìƒë‹¨ Y
            const maxY = 200 + ovalRy; // SVG ì¢Œí‘œê³„ì—ì„œ íƒ€ì› í•˜ë‹¨ Y
            let newY = initialLineY + (svgP.y - startY_drag); // ìƒˆë¡œìš´ Y ìœ„ì¹˜

            // ìƒˆë¡œìš´ Y ìœ„ì¹˜ê°€ ê°€ì´ë“œë¼ì¸ ë²”ìœ„ ë‚´ì— ìˆë„ë¡ í´ë¨í”„
            newY = Math.max(minY, Math.min(maxY, newY)); 

            draggableLineVisual.setAttribute('y1', newY);
            draggableLineVisual.setAttribute('y2', newY);
            draggableLineHandle.setAttribute('y1', newY);
            draggableLineHandle.setAttribute('y2', newY);
            return;
        }

        if (isImageDragging && userImage) { // ì´ë¯¸ì§€ ë“œë˜ê·¸ ë¡œì§
            const dx = e.clientX - startX_drag; // xì¶• ë§ˆìš°ìŠ¤ ì´ë™ëŸ‰
            const dy = e.clientY - startY_drag; // yì¶• ë§ˆìš°ìŠ¤ ì´ë™ëŸ‰

            // í˜„ì¬ ì´ë¯¸ì§€ì˜ ìœ„ì¹˜ (translate ê°’) ì—…ë°ì´íŠ¸
            let newTranslateX = initialImageX + dx;
            let newTranslateY = initialImageY + dy;

            // ì´ë¯¸ì§€ê°€ ì»¨í…Œì´ë„ˆ ë°–ìœ¼ë¡œ ë‚˜ê°€ì§€ ì•Šë„ë¡ ì œí•œ
            const containerRect = guideContainer.getBoundingClientRect();
            const imageRect = userImage.getBoundingClientRect();
            
            // ì´ë¯¸ì§€ì˜ í˜„ì¬ ì¤‘ì•™ ìœ„ì¹˜ (CSS translate(-50%, -50%)ë¥¼ ê³ ë ¤í•œ ì‹¤ì œ ì¤‘ì•™)
            const currentImgCenterX = containerRect.width / 2 + newTranslateX;
            const currentImgCenterY = containerRect.height / 2 + newTranslateY;

            // ì´ë¯¸ì§€ê°€ ì»¨í…Œì´ë„ˆ ì•ˆì— ì™„ì „íˆ ë“¤ì–´ì˜¤ë„ë¡ ì œí•œ
            // ì´ë¯¸ì§€ì˜ ì ˆë°˜ ë„ˆë¹„/ë†’ì´
            const imgHalfWidth = imageRect.width / 2;
            const imgHalfHeight = imageRect.height / 2;

            // ì»¨í…Œì´ë„ˆì˜ ì¤‘ì•™ì„ ê¸°ì¤€ìœ¼ë¡œ ì´ë¯¸ì§€ì˜ ìµœëŒ€/ìµœì†Œ translate ê°’ ê³„ì‚°
            const maxTranslateX = (containerRect.width / 2) - imgHalfWidth;
            const minTranslateX = -((containerRect.width / 2) - imgHalfWidth);
            const maxTranslateY = (containerRect.height / 2) - imgHalfHeight;
            const minTranslateY = -((containerRect.height / 2) - imgHalfHeight);

            // newTranslateX, newTranslateYê°€ ì œí•œ ë²”ìœ„ ë‚´ì— ìˆë„ë¡ ì¡°ì •
            newTranslateX = Math.max(minTranslateX, Math.min(maxTranslateX, newTranslateX));
            newTranslateY = Math.max(minTranslateY, Math.min(maxTranslateY, newTranslateY));
            
            userImage.style.transform = `translate(-50%, -50%) translate(${newTranslateX}px, ${newTranslateY}px)`;

            // ë‹¤ìŒ ì›€ì§ì„ì„ ìœ„í•´ í˜„ì¬ ë§ˆìš°ìŠ¤ ìœ„ì¹˜ ë° ì´ë¯¸ì§€ì˜ translate ê°’ ì—…ë°ì´íŠ¸
            startX_drag = e.clientX;
            startY_drag = e.clientY;
            initialImageX = newTranslateX;
            initialImageY = newTranslateY;
        }
    });

    // ë“œë˜ê·¸ ì¢…ë£Œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ (mouseup)
    window.addEventListener('mouseup', () => {
        if(isLineDragging) {
            isLineDragging = false;
        }
        if(isImageDragging) {
            isImageDragging = false;
            if(userImage) userImage.style.cursor = 'grab';
            // ë“œë˜ê·¸ê°€ ëë‚˜ë©´ transform ê°’ì„ í˜„ì¬ ìœ„ì¹˜ë¡œ ê³ ì • (CSS transform: translate(-50%, -50%)ëŠ” ìœ ì§€)
            // ì´ì „ì— ê³„ì‚°ëœ currentTranslateX, currentTranslateYê°€ í˜„ì¬ ìœ„ì¹˜ë¥¼ ì •í™•íˆ ë°˜ì˜í•˜ë¯€ë¡œ ë³„ë„ ì´ˆê¸°í™” ë¶ˆí•„ìš”
            // ë‹¨, ë§Œì•½ ì´ˆê¸°í™”ê°€ í•„ìš”í•˜ë‹¤ë©´ userImage.style.transform = 'translate(-50%, -50%)'; ë¡œ ë¦¬ì…‹
        }
    });

    // ì‚¬ì§„ ë¶„ì„ í•¨ìˆ˜
    async function analyzePhoto() {
        if (!modelsLoaded) { alert("ë¶„ì„ ëª¨ë¸ì´ ì•„ì§ ë¡œë”© ì¤‘ì…ë‹ˆë‹¤."); return; }
        if (!userImage.src || userImage.style.display === 'none') { alert("ë¨¼ì € ì‚¬ì§„ì„ ì„ íƒí•´ì£¼ì„¸ìš”."); return; }
        if(loader) loader.style.display = 'block';
        if(analyzeBtn) analyzeBtn.style.display = 'none';
        
        try {
            // ì–¼êµ´ ê°ì§€, ëœë“œë§ˆí¬, ì„±ë³„/ë‚˜ì´ ì •ë³´ ëª¨ë‘ ìš”ì²­
            const detection = await faceapi.detectSingleFace(userImage, new faceapi.SsdMobilenetv1Options())
                                        .withFaceLandmarks()
                                        .withAgeAndGender(); 

            if (!detection) {
                if(loader) loader.style.display = 'none';
                if(analyzeBtn) analyzeBtn.style.display = 'block';
                alert("ì–¼êµ´ì„ ì¸ì‹í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë” ì„ ëª…í•˜ê³  ì •ë©´ì„ ë°”ë¼ë³´ëŠ” ì‚¬ì§„ì„ ì‚¬ìš©í•´ì£¼ì„¸ìš”.");
                return;
            }
            
            const canvas = document.getElementById('overlay-canvas');
            const ctx = canvas.getContext('2d');
            
            const imageRect = userImage.getBoundingClientRect(); // ì´ë¯¸ì§€ì˜ ì‹¤ì œ ë Œë”ë§ëœ í¬ê¸°/ìœ„ì¹˜
            const containerRect = guideContainer.getBoundingClientRect(); // ê°€ì´ë“œ ì»¨í…Œì´ë„ˆì˜ í¬ê¸°/ìœ„ì¹˜

            // ìº”ë²„ìŠ¤ í¬ê¸° ë° ìœ„ì¹˜ë¥¼ ì´ë¯¸ì§€ì— ë§ì¶° ì¡°ì •
            canvas.style.top = `${imageRect.top - containerRect.top}px`;
            canvas.style.left = `${imageRect.left - containerRect.left}px`;
            canvas.style.width = `${imageRect.width}px`;
            canvas.style.height = `${imageRect.height}px`;
            canvas.width = imageRect.width;
            canvas.height = imageRect.height;

            const displaySize = { width: imageRect.width, height: imageRect.height };
            const resizedDetections = faceapi.resizeResults(detection, displaySize);
            
            ctx.clearRect(0, 0, canvas.width, canvas.height); // ìº”ë²„ìŠ¤ ì´ˆê¸°í™”
            faceapi.draw.drawFaceLandmarks(canvas, resizedDetections); // ì–¼êµ´ ëœë“œë§ˆí¬ ê·¸ë¦¬ê¸°

            const landmarks = detection.landmarks;
            const jaw = landmarks.getJawOutline();
            const leftEye = landmarks.getLeftEye();
            const rightEye = landmarks.getRightEye();
            const leftBrow = landmarks.getLeftEyeBrow();
            const rightBrow = landmarks.getRightEyeBrow();
            const nose = landmarks.getNose();

            // ì„±ë³„ ì¸ì‹ ê²°ê³¼ (Face-api.js ëª¨ë¸ì— ë”°ë¼ ì •í™•ë„ ë‹¬ë¼ì§ˆ ìˆ˜ ìˆìŒ)
            const gender = detection.gender; 
            const genderText = (gender === 'male') ? 'ë‚¨ì„±' : 'ì—¬ì„±';


            // ì–¼êµ´ ë¹„ìœ¨ (ê°€ë¡œ/ì„¸ë¡œ) - step5 íŒë‹¨ì˜ ì£¼ìš” ê¸°ì¤€
            const faceHeight = jaw[8].y - (jaw[0].y + jaw[16].y) / 2; // í„± ì¤‘ê°„ì  - í„± ì–‘ ë í‰ê·  Y
            const faceWidth = jaw[16].x - jaw[0].x; // í„± ì–‘ ë ê°€ë¡œ ê¸¸ì´
            const aspectRatio = faceHeight / faceWidth;

            // --- ì´ë§ˆ ë„“ì´ ê°œì„  (foreheadText íŒë‹¨ ê¸°ì¤€) ---
            // ì´ë§ˆ ë†’ì´ ì¶”ì •: ëˆˆì¹ ì¤‘ì•™ì  Yì™€ ì½” ìƒë‹¨(ë¯¸ê°„) Yë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì–¼êµ´ ìƒë‹¨ Yë¥¼ ì¶”ì •í•©ë‹ˆë‹¤.
            // (ì´ë§ˆ ëœë“œë§ˆí¬ê°€ ì—†ì–´ ê°„ì ‘ì ì¸ ì¶”ë¡ ì´ë¯€ë¡œ ì™„ë²½í•˜ì§„ ì•ŠìŠµë‹ˆë‹¤.)
            const browAverageY = (leftBrow[2].y + rightBrow[2].y) / 2; 
            const noseTopY = nose[0].y; 
            // `estimatedTopFaceY` ê³„ì‚° ì‹œ ì‚¬ìš©ë˜ëŠ” `1.5`ëŠ” ê²½í—˜ì  ê³„ìˆ˜ì…ë‹ˆë‹¤.
            // ì´ ê°’ì„ **ë†’ì´ë©´ ì´ë§ˆê°€ ë” ë„“ê²Œ ì¸ì‹ë  ê°€ëŠ¥ì„±**ì´ ë†’ì•„ì§€ê³ , **ë‚®ì¶”ë©´ ë” ì¢ê²Œ ì¸ì‹ë  ê°€ëŠ¥ì„±**ì´ ë†’ì•„ì§‘ë‹ˆë‹¤.
            const estimatedTopFaceY = noseTopY - (noseTopY - browAverageY) * 1.5; 
            const foreheadHeight = browAverageY - estimatedTopFaceY; 

            let foreheadText = 'í‰ê· ì ì¸';
            if (foreheadHeight > 0 && faceHeight > 0) {
                 const foreheadToFaceRatio = foreheadHeight / faceHeight; 
                // ì•„ë˜ ì„ê³„ê°’ì„ ì¡°ì ˆí•˜ì—¬ 'ì¢ì€ ì´ë§ˆ'ì™€ 'ë„“ì€ ì´ë§ˆ'ì˜ ê¸°ì¤€ì„ ë³€ê²½í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                // ì²« ë²ˆì§¸ ì„ê³„ê°’(0.20): ì´ ê°’ë³´ë‹¤ ì‘ìœ¼ë©´ 'ì¢ì€ ì´ë§ˆ'ë¡œ íŒë‹¨. (ì‘ì„ìˆ˜ë¡ ì¢ë‹¤ê³  íŒë‹¨í•˜ê¸° ì‰¬ì›€)
                // ë‘ ë²ˆì§¸ ì„ê³„ê°’(0.30): ì´ ê°’ë³´ë‹¤ í¬ë©´ 'ë„“ì€ ì´ë§ˆ'ë¡œ íŒë‹¨. (í´ìˆ˜ë¡ ë„“ë‹¤ê³  íŒë‹¨í•˜ê¸° ì‰¬ì›€)
                // í˜„ì¬ 0.20ê³¼ 0.30 ì‚¬ì´ëŠ” 'í‰ê· ì ì¸' ì´ë§ˆë¡œ ë¶„ë¥˜ë©ë‹ˆë‹¤.
                if (foreheadToFaceRatio < 0.20) { // ê¸°ì¡´ 0.22 -> 0.20ìœ¼ë¡œ ë‹¤ì‹œ ì¡°ì • (ì¢€ ë” ì¢ì•„ì•¼ ì¢ë‹¤ê³  íŒë‹¨)
                    foreheadText = 'ì¢ì€';
                } else if (foreheadToFaceRatio > 0.30) { // ê¸°ì¡´ 0.32 -> 0.30ìœ¼ë¡œ ë‹¤ì‹œ ì¡°ì • (ì¢€ ë” ë„“ì–´ì•¼ ë„“ë‹¤ê³  íŒë‹¨)
                    foreheadText = 'ë„“ì€';
                }
            }


            // --- í„± ëª¨ì–‘ (ê°ë„) ê°œì„  (jawText íŒë‹¨ ê¸°ì¤€) ---
            // í„±ì„  ê°ë„ ê³„ì‚° ë¡œì§ì€ ë™ì¼
            const p1 = jaw[2], p2 = jaw[4], p3 = jaw[8]; 
            const v1 = { x: p1.x - p2.x, y: p1.y - p2.y };
            const v2 = { x: p3.x - p2.x, y: p3.y - p2.y };
            const dotProduct = v1.x * v2.x + v1.y * v2.y;
            const magnitude1 = Math.sqrt(v1.x**2 + v1.y**2), magnitude2 = Math.sqrt(v2.x**2 + v2.y**2);
            let jawAngle = 180; 
            if (magnitude1 > 0 && magnitude2 > 0) {
                jawAngle = Math.acos(dotProduct / (magnitude1 * magnitude2)) * (180 / Math.PI);
            }
            
            let jawText;
            // ì„±ë³„ì— ë”°ë¼ í„± ê°ë„ ì„ê³„ê°’ ì¡°ì •: ë‚¨ì„±ì´ ì—¬ì„±ë³´ë‹¤ í‰ê· ì ìœ¼ë¡œ í„±ì„ ì´ ë” ê°ì§
            // `angleThresholdHard` (ê°ì§„ í„± ê¸°ì¤€): ì´ ê°’ë³´ë‹¤ ì‘ìœ¼ë©´ 'ê°ì§€ê³  ëšœë ·í•œ'. (ì‘ì„ìˆ˜ë¡ ê°ì§„ í„±ìœ¼ë¡œ íŒë‹¨í•˜ê¸° ì‰¬ì›€)
            // `angleThresholdSoft` (ë‘¥ê·¼ í„± ê¸°ì¤€): ì´ ê°’ë³´ë‹¤ í¬ë©´ 'ë‘¥ê¸€ê³  ë¶€ë“œëŸ¬ìš´'. (í´ìˆ˜ë¡ ë‘¥ê·¼ í„±ìœ¼ë¡œ íŒë‹¨í•˜ê¸° ì‰¬ì›€)
            // ë‚¨ì„±ì˜ ì„ê³„ê°’ì„ ì—¬ì„±ë³´ë‹¤ ë‚®ê²Œ ì„¤ì •í•˜ì—¬ ë‚¨ì„±ì´ ë” ì‰½ê²Œ 'ê°ì§„' í„±ìœ¼ë¡œ ë¶„ë¥˜ë˜ë„ë¡ í•¨.
            const angleThresholdHard = (gender === 'male') ? 130 : 138; // ë‚¨ì„± 135 -> 130 (ë” ê°ì ¸ì•¼ ê°ì§„ í„±), ì—¬ì„± 140 -> 138 (ì¡°ê¸ˆ ë” ê°ì§„ ê¸°ì¤€)
            const angleThresholdSoft = (gender === 'male') ? 148 : 155; // ë‚¨ì„± 150 -> 148 (ì¡°ê¸ˆ ë” ë‘¥ê¸€ì–´ì•¼ ë‘¥ê·¼ í„±), ì—¬ì„± 155 (ìœ ì§€)

            if (jawAngle < angleThresholdHard) {
                jawText = 'ê°ì§€ê³  ëšœë ·í•œ';
            } else if (jawAngle > angleThresholdSoft) {
                jawText = 'ë‘¥ê¸€ê³  ë¶€ë“œëŸ¬ìš´';
            } else {
                jawText = 'í‰ê· ì ì¸';
            }


            // --- ëˆˆ ëª¨ì–‘ (ê°€ë¡œ ê¸¸ì´) ê°œì„  (eyeShapeText íŒë‹¨ ê¸°ì¤€) ---
            // ëˆˆ ê°€ë¡œ ê¸¸ì´ / ëˆˆ ì„¸ë¡œ ë†’ì´ ë¹„ìœ¨ë¡œ íŒë‹¨. ë¹„ìœ¨ì´ ë†’ìœ¼ë©´ ê°€ë¡œë¡œ ê¸´ ëˆˆ, ë‚®ìœ¼ë©´ ë‘¥ê·¼ ëˆˆ.
            const oneEyeWidth = leftEye[3].x - leftEye[0].x; // í•œìª½ ëˆˆ ê°€ë¡œ ê¸¸ì´
            const oneEyeHeight = (leftEye[4].y + leftEye[5].y) / 2 - (leftEye[1].y + leftEye[2].y) / 2; // í•œìª½ ëˆˆ ì„¸ë¡œ ë†’ì´
            let eyeShapeRatio = 0;
            if (oneEyeHeight > 0) {
                 eyeShapeRatio = oneEyeWidth / oneEyeHeight;
            }
            
            let eyeShapeText;
            // ì•„ë˜ ì„ê³„ê°’ì„ ì¡°ì ˆí•˜ì—¬ 'ë‘¥ê·¼ ëˆˆ'ê³¼ 'ê°€ë¡œë¡œ ê¸´ ëˆˆ'ì˜ ê¸°ì¤€ì„ ë³€ê²½í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            // ì²« ë²ˆì§¸ ì„ê³„ê°’(2.8): ì´ ê°’ë³´ë‹¤ ì‘ìœ¼ë©´ 'ë‘¥ê·¼ ëˆˆ'ìœ¼ë¡œ íŒë‹¨. (í´ìˆ˜ë¡ ë‘¥ê·¼ ëˆˆìœ¼ë¡œ íŒë‹¨í•˜ê¸° ì‰¬ì›€)
            // ë‘ ë²ˆì§¸ ì„ê³„ê°’(3.5): ì´ ê°’ë³´ë‹¤ í¬ë©´ 'ê°€ë¡œë¡œ ê¸´ ëˆˆ'ìœ¼ë¡œ íŒë‹¨. (ì‘ì„ìˆ˜ë¡ ê¸´ ëˆˆìœ¼ë¡œ íŒë‹¨í•˜ê¸° ì‰¬ì›€)
            // í˜„ì¬ëŠ” 2.8ê³¼ 3.5 ì‚¬ì´ëŠ” 'í‰ê· ì ì¸' ëˆˆìœ¼ë¡œ ë¶„ë¥˜ë©ë‹ˆë‹¤.
            if (eyeShapeRatio < 2.8) { // 2.9 -> 2.8 (ì¡°ê¸ˆë§Œ ë‘¥ê¸€ì–´ë„ ë‘¥ê¸€ë‹¤ê³  íŒë‹¨)
                eyeShapeText = 'ë‘¥ê·¼';
            } else if (eyeShapeRatio > 3.5) { // 3.6 -> 3.5 (ì¡°ê¸ˆë§Œ ê¸¸ì–´ë„ ê¸¸ë‹¤ê³  íŒë‹¨)
                eyeShapeText = 'ê°€ë¡œë¡œ ê¸´';
            } else {
                eyeShapeText = 'í‰ê· ì ì¸';
            }
            

            // --- ëˆˆê³¼ ëˆˆì¹ ì‚¬ì´ ê±°ë¦¬ (step1_result íŒë‹¨ ê¸°ì¤€) ---
            const leftEyeCenterY = (leftEye[1].y + leftEye[2].y + leftEye[4].y + leftEye[5].y) / 4;
            const leftEyebrowY = (landmarks.getLeftEyeBrow()[0].y + landmarks.getLeftEyeBrow()[1].y + landmarks.getLeftEyeBrow()[2].y + landmarks.getLeftEyeBrow()[3].y + landmarks.getLeftEyeBrow()[4].y) / 5;
            const eyeToEyebrowDistance = leftEyeCenterY - leftEyebrowY;
            const normalizedDistance = eyeToEyebrowDistance / oneEyeHeight; // ëˆˆ ë†’ì´ ëŒ€ë¹„ ëˆˆì¹ ê±°ë¦¬ ë¹„ìœ¨
            // ì´ ì„ê³„ê°’(0.7)ì„ ì¡°ì ˆí•˜ì—¬ 'ëˆˆê³¼ ëˆˆì¹ ì‚¬ì´ê°€ ë©€ë‹¤(A)'ì™€ 'ì¢ë‹¤(B)'ì˜ ê¸°ì¤€ì„ ë³€ê²½í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            // ê°’ì´ ì‘ì„ìˆ˜ë¡ 'ë©€ë‹¤(A)'ë¡œ íŒë‹¨í•˜ê¸° ì‰¬ì›Œì§‘ë‹ˆë‹¤.
            const step1_result = (normalizedDistance > 0.7) ? 'A' : 'B';


            // --- ì–¼êµ´ì„  ì¸ìƒ (step2_result íŒë‹¨ ê¸°ì¤€) ---
            // í„± ê°ë„(`jawAngle`)ë¥¼ ì§ì ‘ ì‚¬ìš©.
            // `140`ì€ 'ê°ì§„' ì¸ìƒê³¼ 'ë‘¥ê·¼' ì¸ìƒì˜ ê²½ê³„ì ì…ë‹ˆë‹¤. ì´ ê°’ì„ ì¡°ì ˆí•˜ì—¬ íŒë‹¨ì„ ë³€ê²½í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            // ê°’ì´ ì‘ì„ìˆ˜ë¡ 'ê°ì§„(D)' ì¸ìƒìœ¼ë¡œ íŒë‹¨í•˜ê¸° ì‰¬ì›Œì§‘ë‹ˆë‹¤.
            const step2_result = (jawAngle < 140) ? 'D' : 'C'; 


            // --- ëˆˆ ëª¨ì–‘ (step3_result íŒë‹¨ ê¸°ì¤€) ---
            // `eyeShapeRatio`ë¥¼ ì§ì ‘ ì‚¬ìš©.
            // `2.8`ì€ 'ë‘¥ê·¼ ëˆˆ(E)'ê³¼ 'ê¸´ ëˆˆ(F)'ì˜ ê²½ê³„ì ì…ë‹ˆë‹¤. ì´ ê°’ì„ ì¡°ì ˆí•˜ì—¬ íŒë‹¨ì„ ë³€ê²½í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            // ê°’ì´ ì‘ì„ìˆ˜ë¡ 'ë‘¥ê·¼(E)' ëˆˆìœ¼ë¡œ íŒë‹¨í•˜ê¸° ì‰¬ì›Œì§‘ë‹ˆë‹¤.
            const step3_result = (eyeShapeRatio < 2.8) ? 'E' : 'F'; 


            // --- ì´ëª©êµ¬ë¹„ ì§‘ì¤‘ë„ (step4_result íŒë‹¨ ê¸°ì¤€) ---
            // ë¯¸ê°„ ê°„ê²© / í•œìª½ ëˆˆ ë„ˆë¹„ ë¹„ìœ¨(`eyeSpacingRatio`)ì„ ì‚¬ìš©.
            // `0.9`ëŠ” 'ì¤‘ì•™ì— ëª¨ì„(A)'ê³¼ 'ë„“ê²Œ í¼ì§(B)'ì˜ ê²½ê³„ì ì…ë‹ˆë‹¤. ì´ ê°’ì„ ì¡°ì ˆí•˜ì—¬ íŒë‹¨ì„ ë³€ê²½í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            // ê°’ì´ ì‘ì„ìˆ˜ë¡ 'ì¤‘ì•™ì— ëª¨ì„(A)'ìœ¼ë¡œ íŒë‹¨í•˜ê¸° ì‰¬ì›Œì§‘ë‹ˆë‹¤.
            const eyeSpacingMidEyeDistance = rightEye[0].x - leftEye[3].x;
            const eyeSpacingOneEyeWidth = leftEye[3].x - leftEye[0].x;
            let eyeSpacingRatioForStep4 = 0;
            if (eyeSpacingOneEyeWidth > 0) {
                 eyeSpacingRatioForStep4 = eyeSpacingMidEyeDistance / eyeSpacingOneEyeWidth;
            }
            const step4_result = (eyeSpacingRatioForStep4 < 0.9) ? 'A' : 'B'; 


            // --- ì–¼êµ´ ê°€ë¡œ/ì„¸ë¡œ ë¹„ìœ¨ (step5_result íŒë‹¨ ê¸°ì¤€) ---
            // `aspectRatio` (ì–¼êµ´ ë†’ì´ / ì–¼êµ´ ë„ˆë¹„)ë¥¼ ì‚¬ìš©.
            // `1.25`ëŠ” 'ë™ê·¸ë€ ì–¼êµ´í˜•(C)'ê³¼ 'íƒ€ì›í˜•/ê¸´ ì–¼êµ´í˜•(D)'ì˜ ê²½ê³„ì ì…ë‹ˆë‹¤. ì´ ê°’ì„ ì¡°ì ˆí•˜ì—¬ íŒë‹¨ì„ ë³€ê²½í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            // ê°’ì´ ì‘ì„ìˆ˜ë¡ 'ë™ê·¸ë€(C)' ì–¼êµ´í˜•ìœ¼ë¡œ íŒë‹¨í•˜ê¸° ì‰¬ì›Œì§‘ë‹ˆë‹¤.
            const step5_result = (aspectRatio < 1.25) ? 'C' : 'D'; 


            // --- ë¯¸ê°„ ë„ˆë¹„ì™€ ì¸ìƒ (step6_result íŒë‹¨ ê¸°ì¤€) ---
            // `step4_result` (ì´ëª©êµ¬ë¹„ ì§‘ì¤‘ë„)ì™€ `step2_result` (ì–¼êµ´ì„  ì¸ìƒ)ë¥¼ ë³µí•©ì ìœ¼ë¡œ í™œìš©í•©ë‹ˆë‹¤.
            let step6_result;
            // 'E' (ë¯¸ê°„ ì¢ê³  ë¶€ë“œëŸ¬ìš´ ì¸ìƒ)ìœ¼ë¡œ íŒë‹¨ë˜ëŠ” ì¡°ê±´:
            // ì´ëª©êµ¬ë¹„ê°€ ì¤‘ì•™ì— ëª¨ì—¬ìˆê³  (step4 'A'), ì–¼êµ´ì„ ì´ ë‘¥ê¸€ ë•Œ (step2 'C').
            // ì´ ì¡°ê±´ì„ ê°•í™”/ì™„í™”í•˜ë ¤ë©´ ìœ„ì˜ step4_resultì™€ step2_resultì˜ íŒë‹¨ ì„ê³„ê°’ì„ ì¡°ì ˆí•´ì•¼ í•©ë‹ˆë‹¤.
            if (step4_result === 'A' && step2_result === 'C') { 
                step6_result = 'E';
            } else {
                step6_result = 'F';
            }


            const analysisResult = { 
                step1: step1_result, 
                step2: step2_result, 
                step3: step3_result, 
                step4: step4_result, 
                step5: step5_result, 
                step6: step6_result,
                gender: genderText,
                forehead: foreheadText,
                jaw: jawText,
                eyeShape: eyeShapeText,
                eyeSpacing: eyeSpacingTextDetailed // ìƒì„¸ ë¯¸ê°„ ê°„ê²© í…ìŠ¤íŠ¸
            };
            
            displayResults(analysisResult, true); // ì‚¬ì§„ ë¶„ì„ ê²°ê³¼ì„ì„ ì•Œë¦¼
            showPage('result-page');

        } catch (error) {
            console.error("ì‚¬ì§„ ë¶„ì„ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
            alert("ì‚¬ì§„ì„ ë¶„ì„í•˜ëŠ” ì¤‘ì— ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì–¼êµ´ì´ ì˜ ë‚˜ì˜¨ ë‹¤ë¥¸ ì‚¬ì§„ìœ¼ë¡œ ì‹œë„í•´ë³´ê±°ë‚˜, ì„¤ë¬¸ìœ¼ë¡œ ì§„ë‹¨í•˜ëŠ” ë°©ë²•ì„ ì´ìš©í•´ì£¼ì„¸ìš”. (ì„¸ë¶€ ì˜¤ë¥˜: " + error.message + ")");
        } finally {
            if(loader) loader.style.display = 'none';
            if(analyzeBtn) analyzeBtn.style.display = 'block';
        }
    }

    // ì„¤ë¬¸ ë¶„ì„ í•¨ìˆ˜
    function analyzeQuiz() {
        const form = document.getElementById('quiz-form');
        const analysisResult = {
            step1: form.elements['q1'].value,
            step2: form.elements['q2'].value,
            step3: form.elements['q3'].value,
            step4: form.elements['q4'].value,
            step5: form.elements['q5'].value,
            step6: form.elements['q6'].value,
        };
        if (Object.values(analysisResult).some(v => !v)) {
            alert("ëª¨ë“  ì§ˆë¬¸ì— ë‹µë³€í•´ì£¼ì„¸ìš”!");
            return;
        }
        displayResults(analysisResult, false); // ì„¤ë¬¸ ë¶„ì„ ê²°ê³¼ì„ì„ ì•Œë¦¼
        showPage('result-page');
    }

    // ê²°ê³¼ í‘œì‹œ í•¨ìˆ˜
    function displayResults(analysis, fromPhoto = false) {
        const content = document.getElementById('result-content');
        if (!content) return;

        // 1. ìµœì¢… ìœ í˜•(Type) ê²°ì • ë¡œì§ (ì„¤ë¬¸/ì‚¬ì§„ ë¶„ì„ ê²°ê³¼ì˜ step1, step2ì— ê¸°ë°˜)
        let finalType;
        if (analysis.step2 === 'D' && analysis.step1 === 'A') finalType = 'A';
        else if (analysis.step2 === 'D' && analysis.step1 === 'B') finalType = 'B';
        else if (analysis.step2 === 'C' && analysis.step1 === 'A') finalType = 'C';
        else finalType = 'D';

        // 2. ê° íƒ€ì…ë³„ ì •ë³´
        const typeInfo = {
            'A': {
                title: "Type A : ì„¸ë ¨ëœ íŒŒì›Œ ì…€ëŸ½í˜•",
                description: "ë˜ë ·í•œ ì¸ìƒì„ ì£¼ëŠ” ê°ì§„ ëª¨ì–‘ê³¼ í’ì„±í•˜ê³  ë„í†°í•œ ëˆˆì¹ì˜ ì¡°í•©ì…ë‹ˆë‹¤. ìì‹ ê° ìˆê³  ì¹´ë¦¬ìŠ¤ë§ˆ ë„˜ì¹˜ëŠ” ì´ë¯¸ì§€ë¥¼ ì—°ì¶œí•˜ê¸°ì— ì¢‹ìŠµë‹ˆë‹¤. ëˆˆì¹ì˜ ì „ì²´ì ì¸ ê¸¸ì´ëŠ” ì•„ë˜ ìƒì„¸ ê°€ì´ë“œì—ì„œ ë‹¹ì‹ ì˜ ì–¼êµ´ ë¹„ìœ¨ì— ë§ê²Œ ì¡°ì ˆí•˜ì—¬, ì „ì²´ì ì¸ ì¸ìƒì˜ ì™„ì„±ë„ë¥¼ ë†’ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.",
                celebrities: ["ê¹€í˜œìˆ˜", "í•œì†Œí¬"], 
                image: "https://image.isplus.com/data/isp/image/2025/03/20/isp20250320000163.800x.0.jpg"
            },
            'B': {
                title: "Type B : ì‹œí¬í•œ ë„ì‹œ ëª¨ë¸í˜•",
                description: "ë‚ ì¹´ë¡­ê³  ì„¸ë ¨ëœ ëŠë‚Œì˜ ê°ì§„ ëª¨ì–‘ê³¼ ì–‡ê³  ì •êµí•œ ëˆˆì¹ì˜ ì¡°í•©ì…ë‹ˆë‹¤. ì‹œí¬í•˜ê³  ë„íšŒì ì¸ ë¶„ìœ„ê¸°ë¥¼ ì—°ì¶œí•˜ëŠ” ë° íš¨ê³¼ì ì…ë‹ˆë‹¤. ëˆˆì¹ì˜ ì „ì²´ì ì¸ ê¸¸ì´ëŠ” ì•„ë˜ ìƒì„¸ ê°€ì´ë“œì—ì„œ ë‹¹ì‹ ì˜ ì–¼êµ´ ë¹„ìœ¨ì— ë§ê²Œ ì¡°ì ˆí•˜ì—¬, ì „ì²´ì ì¸ ì¸ìƒì˜ ì™„ì„±ë„ë¥¼ ë†’ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.",
                celebrities: ["ê¹€ì„œí˜•", "ì•„ì´ìœ "], 
                image: "https://www.elle.co.kr/resources_old/online/org_online_image/el/a15eacb9-d825-4655-9264-24e5b93b58c9.jpg"
            },
            'C': {
                title: "Type C : ë¶€ë“œëŸ¬ìš´ ì²«ì‚¬ë‘í˜•",
                description: "ì„ í•˜ê³  ë¶€ë“œëŸ¬ìš´ ì¸ìƒì„ ì£¼ëŠ” ë‘¥ê·¼ ëª¨ì–‘ê³¼ ìì—°ìŠ¤ëŸ½ê³  ë„í†°í•œ ëˆˆì¹ì˜ ì¡°í•©ì…ë‹ˆë‹¤. ì²­ìˆœí•˜ê³  ì–´ë ¤ ë³´ì´ëŠ” ì´ë¯¸ì§€ë¥¼ ë§Œë“œëŠ” ë° ê°€ì¥ ì´ìƒì ì…ë‹ˆë‹¤. ëˆˆì¹ì˜ ì „ì²´ì ì¸ ê¸¸ì´ëŠ” ì•„ë˜ ìƒì„¸ ê°€ì´ë“œì—ì„œ ë‹¹ì‹ ì˜ ì–¼êµ´ ë¹„ìœ¨ì— ë§ê²Œ ì¡°ì ˆí•˜ì—¬, ì „ì²´ì ì¸ ì¸ìƒì˜ ì™„ì„±ë„ë¥¼ ë†’ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.",
                celebrities: ["ì œë‹ˆ(ë¸”ë™í•‘í¬)", "ì„ìœ¤ì•„"], 
                image: "https://t1.daumcdn.net/news/202504/18/inews24/20250418141440222zwyv.jpg"
            },
            'D': {
                title: "Type D : ë‹¨ì•„í•œ í´ë˜ì‹í˜•",
                description: "ë¶€ë“œëŸ¬ìš´ ê³¡ì„  ëª¨ì–‘ê³¼ ê¹”ë”í•˜ê³  ì–‡ì€ ëˆˆì¹ì˜ ì¡°í•©ì…ë‹ˆë‹¤. ë‹¨ì•„í•˜ê³  í´ë˜ì‹í•œ ë¶„ìœ„ê¸°ë¥¼ ì—°ì¶œí•˜ë©°, ê°€ì¥ ì‹¤íŒ¨ í™•ë¥ ì´ ì ì€ ìŠ¤íƒ€ì¼ì…ë‹ˆë‹¤. ëˆˆì¹ì˜ ì „ì²´ì ì¸ ê¸¸ì´ëŠ” ì•„ë˜ ìƒì„¸ ê°€ì´ë“œì—ì„œ ë‹¹ì‹ ì˜ ì–¼êµ´ ë¹„ìœ¨ì— ë§ê²Œ ì¡°ì ˆí•˜ì—¬, ì „ì²´ì ì¸ ì¸ìƒì˜ ì™„ì„±ë„ë¥¼ ë†’ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.",
                celebrities: ["ê¹€ê³ ì€", "ì†¡í˜œêµ"], 
                image: "https://img-s-msn-com.akamaized.net/tenant/amp/entityid/AA1HC3K5.img?w=650&h=865&m=6&x=172&y=224&s=289&d=289"
            }
        };

        const currentType = typeInfo[finalType];
        
        // ìƒì„¸ ê°€ì´ë“œ í…ìŠ¤íŠ¸
        const detailTexts = {
            shape: analysis.step2 === 'D' ? 'ì‚°ê³¼ ê°ì„ ì‚´ë¦°' : 'ë¶€ë“œëŸ¬ìš´ ê³¡ì„ ',
            thickness: analysis.step1 === 'A' ? 'ë„í†°í•œ' : 'ì–‡ì€',
            length: analysis.step5 === 'C' ? 'ì¡°ê¸ˆ ê¸¸ê²Œ ê·¸ë ¤' : 'ì¡°ê¸ˆ ì§§ê²Œ ê·¸ë ¤',
            detail: `ëˆˆì¹ ${analysis.step4 === 'A' ? 'ì‚°ì„ ê¸¸ê²Œ, ê¼¬ë¦¬ë¥¼ ì§§ê²Œ' : 'ì‚°ì„ ì§§ê²Œ, ê¼¬ë¦¬ë¥¼ ê¸¸ê²Œ'}, ${analysis.step6 === 'E' ? 'ì•ë¨¸ë¦¬ëŠ” ì˜…ê²Œ í‘œí˜„' : 'ì•ë¨¸ë¦¬ ê²°ì„ ì‚´ë ¤ í‘œí˜„'}`
        };

        // ì‚¬ì§„ ë¶„ì„ ê²°ê³¼ì¼ ê²½ìš°ì—ë§Œ ì¶”ê°€ ì •ë³´ í‘œì‹œ
        let analysisDetailsHTML = '';
        if (fromPhoto) {
            analysisDetailsHTML = `
                <h4>ì‚¬ì§„ ë¶„ì„ ê²°ê³¼</h4>
                <ul style="list-style-type: disc; margin-left: 20px;">
                    <li>ì˜ˆìƒ ì„±ë³„: <strong>${analysis.gender}</strong></li>
                    <li>ì´ë§ˆ: <strong>${analysis.forehead}</strong> í¸ì…ë‹ˆë‹¤.</li>
                    <li>í„±: <strong>${analysis.jaw}</strong> í¸ì…ë‹ˆë‹¤.</li>
                    <li>ëˆˆ ëª¨ì–‘: <strong>${analysis.eyeShape}</strong> í¸ì…ë‹ˆë‹¤.</li>
                    <li>ë¯¸ê°„ ê°„ê²©: <strong>${analysis.eyeSpacing}</strong> í¸ì…ë‹ˆë‹¤.</li>
                    <li>ì–¼êµ´ ë¹„ìœ¨: ê°€ë¡œ/ì„¸ë¡œ ë¹„ìœ¨ì€ <strong>${analysis.step5 === 'C' ? 'ë™ê·¸ë€ ì–¼êµ´í˜•ì— ê°€ê¹ê³ ' : 'íƒ€ì›í˜•/ê¸´ ì–¼êµ´í˜•ì— ê°€ê¹ìŠµë‹ˆë‹¤'}</strong>.</li>
                    <li>ëˆˆê³¼ ëˆˆì¹ ì‚¬ì´: <strong>${analysis.step1 === 'A' ? 'ëˆˆê³¼ ëˆˆì¹ ì‚¬ì´ê°€ ë©€ê³ ' : 'ëˆˆê³¼ ëˆˆì¹ ì‚¬ì´ê°€ ì¢ìŠµë‹ˆë‹¤'}</strong>.</li>
                </ul>
                <p class="photo-basis">â€» ìœ„ ê²°ê³¼ëŠ” AI ë¶„ì„ì— ê¸°ë°˜í•œ ê²ƒìœ¼ë¡œ, ì‹¤ì œì™€ ë‹¤ë¥¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                <hr style="border-top: 1px dashed #ccc; margin: 20px 0;">
            `;
        }

        // ìµœì¢… ê²°ê³¼ HTML êµ¬ì¡°
        const resultHTML = `
            <div class="result-card">
                <h3>${currentType.title}</h3>
                <p style="font-weight: 500;">${currentType.description}</p>
                ${analysisDetailsHTML}
                <div style="margin: 20px 0;">
                    <img src="${currentType.image}" alt="${currentType.title}" style="width: 100%; border-radius: 8px;">
                    <p style="font-size: 0.9em; color: #555; margin-top: 10px;">(ì˜ˆì‹œ: ${currentType.celebrities.join(', ')} ìŠ¤íƒ€ì¼)</p>
                </div>

                <h4>ë‹¹ì‹ ì„ ìœ„í•œ ìƒì„¸ ê°€ì´ë“œ</h4>
                <ul>
                    <li><strong>ëª¨ì–‘:</strong> ${detailTexts.shape} ëˆˆì¹</li>
                    <li><strong>ë‘ê»˜:</strong> ${detailTexts.thickness} ëˆˆì¹</li>
                    <li><strong>ê¸¸ì´:</strong> ${detailTexts.length} ì–¼êµ´ ë¹„ìœ¨ ë³´ì™„</li>
                    <li><strong>ë””í…Œì¼:</strong> ${detailTexts.detail}</li>
                </ul>
            </div>
        `;

        content.innerHTML = resultHTML;
    }
</script>
</body>
</html>
