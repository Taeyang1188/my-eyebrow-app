<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>çœ‰ì™„ì„±: ë‚´ ì¸ìƒ ëˆˆì¹ ì°¾ê¸°</title>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <style>
        :root {
            --primary-color: #6a5acd; /* SlateBlue */
            --secondary-color: #f0e6ff;
            --text-color: #333;
            --bg-color: #f8f9fa;
            --container-bg: #ffffff;
            --border-radius: 16px;
            --shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            box-sizing: border-box;
            color: var(--text-color);
        }
        .main-container {
            width: 100%;
            max-width: 500px;
            background-color: var(--container-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 25px;
            box-sizing: border-box;
            text-align: center;
        }
        h1, h2, h3, h4 {
            margin: 0 0 15px;
            color: var(--primary-color);
        }
        h1 { font-size: 2rem; }
        h2 { font-size: 1.6rem; }
        h4 { font-size: 1.1rem; margin-top: 20px;}
        p { line-height: 1.7; margin: 0 0 20px; }
        .btn {
            display: block; width: 100%; padding: 15px; margin: 10px 0;
            border: none; border-radius: 12px; background-color: var(--primary-color);
            color: white; font-size: 1.1rem; font-weight: bold; cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
        }
        .btn:hover { background-color: #5a4ab9; }
        .btn:active { transform: scale(0.98); }
        .btn.secondary {
             background-color: #e9ecef; color: var(--text-color);
        }
        #photo-page .btn.secondary {
            display: inline-block;
            width: auto;
            padding: 15px 30px;
        }
        .btn.secondary:hover { background-color: #d3d9df; }
        .page { display: none; }
        .page.active { display: block; }
        #guide-container {
            width: 100%; aspect-ratio: 3 / 4; background-color: #e9ecef;
            border: 2px dashed #ced4da; border-radius: 12px;
            position: relative; overflow: hidden; user-select: none; margin: 20px 0;
        }
        #user-image, #overlay-canvas, #guideline-svg {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            max-width: 100%; max-height: 100%;
            height: auto; width: 80%;
        }
        #user-image { z-index: 10; cursor: grab; }
        #user-image:active { cursor: grabbing; }
        #guideline-svg { z-index: 20; pointer-events: none; }
        #overlay-canvas { z-index: 30; pointer-events: none; }
        #guideline-svg .draggable-line {
            pointer-events: all;
            cursor: ns-resize;
            stroke-width: 8px;
            stroke: rgba(0,0,0,0);
        }
        .sliders {
            margin-top: 20px; padding: 20px;
            background-color: #f8f9fa; border-radius: 8px;
        }
        .slider-group {
            display: flex; align-items: center;
            gap: 15px; margin-bottom: 15px;
        }
        .slider-group label { font-size: 14px; width: 100px; text-align: left;}
        input[type="range"] { flex-grow: 1; }
        .description-text {
            font-size: 0.8em; color: #888; text-align: left;
            padding-left: 10px; border-left: 3px solid #e0e0e0;
        }
        .question { margin-bottom: 30px; text-align: left; }
        .question p { font-weight: 500; margin-bottom: 15px; }
        .options { display: flex; flex-direction: column; gap: 10px; }
        .result-card {
            background-color: var(--secondary-color); border-radius: 12px;
            padding: 20px; margin-bottom: 15px; text-align: left;
        }
        .result-card h3 { color: var(--primary-color); border-bottom: 2px solid var(--primary-color); padding-bottom: 10px; margin-bottom: 15px;}
        .result-card ul { padding-left: 20px; margin: 0; list-style-type: none;}
        .result-card li { margin-bottom: 12px; }
        /* [ì¶”ê°€] ì‚¬ì§„ ë¶„ì„ ê²°ê³¼ í…ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
        .photo-basis {
            font-size: 0.8em;
            color: #666;
            display: block;
            padding-left: 10px;
            border-left: 2px solid var(--primary-color);
            margin-top: 5px;
        }
        #loader {
            border: 8px solid #f3f3f3; border-radius: 50%;
            border-top: 8px solid var(--primary-color);
            width: 60px; height: 60px;
            animation: spin 1s linear infinite; margin: 30px auto; display: none;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div class="main-container">

        <div id="start-page" class="page active">
            <h1>çœ‰ì™„ì„±</h1>
            <p><strong>ë‚´ ì–¼êµ´ì— ë”± ë§ëŠ” ì¸ìƒ ëˆˆì¹ì„ ì°¾ì•„ë³´ì„¸ìš”!</strong><br>ë‘ ê°€ì§€ ë°©ë²• ì¤‘ í•˜ë‚˜ë¥¼ ì„ íƒí•´ ì§„ë‹¨ì„ ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
            <button class="btn" onclick="showPage('photo-page')">ğŸ“¸ ì‚¬ì§„ìœ¼ë¡œ ë¶„ì„í•˜ê¸°</button>
            <button class="btn" onclick="showPage('quiz-page')">âœï¸ ì„¤ë¬¸ìœ¼ë¡œ ì§„ë‹¨í•˜ê¸°</button>
            <p style="font-size: 0.8em; color: #888; margin-top: 20px;">
                ì‚¬ì§„ì€ ì„œë²„ì— ì €ì¥ë˜ì§€ ì•Šìœ¼ë©°, ë¶„ì„ì€ ëª¨ë‘ ì‚¬ìš©ìì˜ ê¸°ê¸°ì—ì„œë§Œ ì´ë£¨ì–´ì§‘ë‹ˆë‹¤.
            </p>
        </div>

        <div id="photo-page" class="page">
            <h2>ì‚¬ì§„ìœ¼ë¡œ ë¶„ì„í•˜ê¸°</h2>
            <p>ì •ë©´ì„ ë°”ë¼ë³´ëŠ” ì„ ëª…í•œ ì‚¬ì§„ì„ ì˜¬ë¦¬ê³ <br>ê°€ì´ë“œë¼ì¸ì— ë§ì¶° ì–¼êµ´ì„ ì¡°ì •í•´ì£¼ì„¸ìš”.</p>
            
            <label for="file-input" class="btn secondary">ğŸ–¼ï¸ ì‚¬ì§„ ì„ íƒ</label>
            <input type="file" id="file-input" accept="image/*" style="display:none;">

            <div id="guide-container">
                <svg id="guideline-svg" viewbox="0 0 300 400" preserveAspectRatio="xMidYMid meet">
                    <ellipse id="oval-guide" cx="150" cy="200" rx="100" ry="130" stroke="rgba(0,0,0,0.5)" stroke-width="2" stroke-dasharray="5,5" fill="none" />
                    <line id="red-line" x1="50" y1="200" x2="250" y2="200" stroke="red" stroke-width="1.5" />
                    <line id="blue-line" x1="150" y1="70" x2="150" y2="330" stroke="blue" stroke-width="1.5" />
                    <line class="green-line" x1="75" y1="70" x2="75" y2="330" stroke="green" stroke-width="1" />
                    <line class="green-line" x1="125" y1="70" x2="125" y2="330" stroke="green" stroke-width="1" />
                    <line class="green-line" x1="175" y1="70" x2="175" y2="330" stroke="green" stroke-width="1" />
                    <line class="green-line" x1="225" y1="70" x2="225" y2="330" stroke="green" stroke-width="1" />
                    <line id="draggable-line-visual" x1="50" y1="220" x2="250" y2="220" stroke="skyblue" stroke-width="2" />
                    <line class="draggable-line" id="draggable-line-handle" x1="50" y1="220" x2="250" y2="220" />
                </svg>
                <img id="user-image" src="" alt="User's face" style="display:none;">
                <canvas id="overlay-canvas"></canvas>
            </div>

            <div id="photo-controls" style="display:none;">
                <div class="sliders">
                    <p class="description-text"><strong>ì‚¬ì§„ ì¡°ì ˆ</strong></p>
                    <div class="slider-group">
                        <label for="size-slider">ì‚¬ì§„ í¬ê¸°</label>
                        <input type="range" id="size-slider" min="10" max="250" value="80">
                    </div>
                    <div class="slider-group">
                        <label for="opacity-slider">ì‚¬ì§„ íˆ¬ëª…ë„</label>
                        <input type="range" id="opacity-slider" min="0" max="1" step="0.05" value="0.7">
                    </div>
                </div>
                <div class="sliders">
                     <p class="description-text"><strong>ê°€ì´ë“œë¼ì¸ ì¡°ì ˆ</strong></p>
                    <div class="slider-group">
                        <label for="guideline-size-slider">ì „ì²´ í¬ê¸°</label>
                        <input type="range" id="guideline-size-slider" min="50" max="150" value="100">
                    </div>
                     <p class="description-text" style="font-size:0.75em; margin-top: 5px;">
                        ê°€ì´ë“œë¼ì¸ì„ ì¡°ì ˆí•˜ì—¬ ì–¼êµ´ ë¹„ìœ¨ì„ ì§ì ‘ í™•ì¸í•´ë³´ì„¸ìš”.
                    </p>
                </div>
            </div>
            
            <p class="description-text" style="margin-top:15px; font-size: 0.9em;">
                <strong>ë™ê·¸ë€ ì–¼êµ´:</strong> ì–¼êµ´ì˜ ê°€ë¡œì™€ ì„¸ë¡œ ê¸¸ì´ê°€ 1:1.1 ì •ë„ë¡œ ë¹„ìŠ·<br>
                <strong>íƒ€ì›í˜• ì–¼êµ´:</strong> ê°€ë¡œë³´ë‹¤ ì„¸ë¡œ ê¸¸ì´ê°€ 1:1.4 ì´ìƒìœ¼ë¡œ í›¨ì”¬ ê¹€
            </p>
            
            <div id="loader"></div>
            <button class="btn" id="analyze-btn" onclick="analyzePhoto()" style="display:none;">ê²°ê³¼ ë¶„ì„í•˜ê¸°</button>
            <button class="btn secondary" onclick="showPage('start-page')">ë’¤ë¡œ ê°€ê¸°</button>
        </div>

        <div id="quiz-page" class="page">
            <h2>ì„¤ë¬¸ìœ¼ë¡œ ì§„ë‹¨í•˜ê¸°</h2>
            <p>ì•„ë˜ ì§ˆë¬¸ì— ë‹µí•˜ì—¬<br>ìì‹ ì—ê²Œ ê¼­ ë§ëŠ” ëˆˆì¹ ìŠ¤íƒ€ì¼ì„ ì°¾ì•„ë³´ì„¸ìš”.</p>
            <form id="quiz-form">
                <div class="question">
                    <p>1. ë‚´ ì–¼êµ´ì˜ íŠ¹ì§•ì€ ì–´ë””ì— ê°€ê¹ë‚˜ìš”?</p>
                    <div class="options">
                        <label><input type="radio" name="q1" value="A"> ì–¼êµ´ì´ ê¸¸ê±°ë‚˜, ëˆˆê³¼ ëˆˆì¹ ì‚¬ì´ê°€ ë©€ë‹¤.</label>
                        <label><input type="radio" name="q1" value="B"> ì–¼êµ´ì´ ì§§ê±°ë‚˜, ëˆˆê³¼ ëˆˆì¹ ì‚¬ì´ê°€ ì¢ë‹¤.</label>
                    </div>
                </div>
                <div class="question">
                    <p>2. ë‚˜ì˜ ì „ì²´ì ì¸ ì¸ìƒì´ë‚˜ ì–¼êµ´ ë¼ì¸ì€?</p>
                    <div class="options">
                        <label><input type="radio" name="q2" value="C"> ì–¼êµ´ì„ ì´ ë‘¥ê¸€ê³ , ì²­ìˆœí•˜ê³  ë¶€ë“œëŸ¬ìš´ ì¸ìƒì´ë‹¤.</label>
                        <label><input type="radio" name="q2" value="D"> ì–¼êµ´ì„ ì´ ê°ì§€ê³ , ì„¸ë ¨ë˜ê³  ë˜ë ·í•œ ì¸ìƒì´ë‹¤.</label>
                    </div>
                </div>
                <div class="question">
                    <p>3. ë‚´ ëˆˆ ëª¨ì–‘ì€ ì–´ë–¤ê°€ìš”?</p>
                    <div class="options">
                        <label><input type="radio" name="q3" value="E"> ëˆˆì´ ì „ì²´ì ìœ¼ë¡œ ë™ê·¸ë€ í¸ì´ë‹¤.</label>
                        <label><input type="radio" name="q3" value="F"> ëˆˆì´ ê°€ë¡œë¡œ ê¸´ í¸ì´ë‹¤.</label>
                    </div>
                </div>
                <div class="question">
                    <p>4. ë‚´ ì´ëª©êµ¬ë¹„ëŠ” ì–¼êµ´ ì¤‘ì•™ì— ëª¨ì—¬ìˆëŠ” í¸ì¸ê°€ìš”?</p>
                    <div class="options">
                        <label><input type="radio" name="q4" value="A"> ì´ëª©êµ¬ë¹„ê°€ ì¤‘ì•™ì— ëª¨ì—¬ìˆê³ , ëˆˆ ì‚¬ì´ê°€ ê°€ê¹ë‹¤ (ë‚´ì‹¬ì•ˆ).</label>
                        <label><input type="radio" name="q4" value="B"> ì´ëª©êµ¬ë¹„ê°€ ë„“ê²Œ í¼ì ¸ìˆê³ , ëˆˆ ì‚¬ì´ê°€ ë©€ë‹¤ (ì™¸ì‹¬ì•ˆ).</label>
                    </div>
                </div>
                <div class="question">
                    <p>5. ë‚´ ì–¼êµ´ì˜ ê°€ë¡œ/ì„¸ë¡œ ë¹„ìœ¨ì€ ì–´ë–¤ê°€ìš”?</p>
                    <div class="options">
                        <label><input type="radio" name="q5" value="C"> ê°€ë¡œ ëŒ€ë¹„ ì„¸ë¡œ ê¸¸ì´ê°€ ì§§ì€ ë™ê·¸ë€ ì–¼êµ´í˜•ì´ë‹¤.</label>
                        <label><input type="radio" name="q5" value="D"> ê°€ë¡œ ëŒ€ë¹„ ì„¸ë¡œ ê¸¸ì´ê°€ ê¸´ íƒ€ì›í˜•/ê¸´ ì–¼êµ´í˜•ì´ë‹¤.</label>
                    </div>
                </div>
                <div class="question">
                    <p>6. ë‚˜ì˜ ë¯¸ê°„ ë„ˆë¹„ì™€ ì¶”êµ¬í•˜ëŠ” ì¸ìƒì€?</p>
                    <div class="options">
                        <label><input type="radio" name="q6" value="E"> ë¯¸ê°„ì´ ì¢ì€ í¸ì´ë©°, ë¶€ë“œëŸ¬ìš´ ì¸ìƒì„ ì›í•œë‹¤.</label>
                        <label><input type="radio" name="q6" value="F"> ë¯¸ê°„ì´ ë„“ì€ í¸ì´ë©°, ë˜ë ·í•œ ì¸ìƒì„ ì›í•œë‹¤.</label>
                    </div>
                </div>
                <button type="button" class="btn" onclick="analyzeQuiz()">ê²°ê³¼ í™•ì¸í•˜ê¸°</button>
                <button type="button" class="btn secondary" onclick="showPage('start-page')">ë’¤ë¡œ ê°€ê¸°</button>
            </form>
        </div>

        <div id="result-page" class="page">
            <h2>ì§„ë‹¨ ê²°ê³¼ ğŸ§</h2>
            <p>ë‹¹ì‹ ì—ê²Œ ì–´ìš¸ë¦¬ëŠ” ìµœê³ ì˜ ëˆˆì¹ ìŠ¤íƒ€ì¼ì„ ì¶”ì²œí•©ë‹ˆë‹¤!</p>
            <div id="result-content"></div>
            <button class="btn" onclick="showPage('start-page')">ë‹¤ì‹œ í•˜ê¸°</button>
        </div>
        
    </div>

<script>
    const pages = document.querySelectorAll('.page');
    const loader = document.getElementById('loader');
    let modelsLoaded = false;

    function showPage(pageId) {
        pages.forEach(page => page.classList.remove('active'));
        const targetPage = document.getElementById(pageId);
        if (targetPage) {
            targetPage.classList.add('active');
        }
        if (pageId === 'start-page') {
            const fileInput = document.getElementById('file-input');
            const userImage = document.getElementById('user-image');
            const photoControls = document.getElementById('photo-controls');
            const analyzeBtn = document.getElementById('analyze-btn');
            const canvas = document.getElementById('overlay-canvas');
            if(fileInput) fileInput.value = '';
            if(userImage) { userImage.src = ''; userImage.style.display = 'none'; }
            if(photoControls) photoControls.style.display = 'none';
            if(analyzeBtn) analyzeBtn.style.display = 'none';
            if(canvas) { canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height); }
        }
    }

    async function loadModels() {
        const MODEL_URL = './models';
        try {
            await faceapi.nets.ssdMobilenetv1.loadFromUri(MODEL_URL);
            await faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL);
            modelsLoaded = true;
            console.log("ëª¨ë¸ ë¡œë”© ì™„ë£Œ!");
        } catch (error) {
            console.error("ëª¨ë¸ ë¡œë”© ì‹¤íŒ¨:", error);
            alert("ë¶„ì„ ëª¨ë¸ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        }
    }
    loadModels();

    const fileInput = document.getElementById('file-input');
    const userImage = document.getElementById('user-image');
    const photoControls = document.getElementById('photo-controls');
    const analyzeBtn = document.getElementById('analyze-btn');
    const guideContainer = document.getElementById('guide-container');

    if (fileInput) {
        fileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;
            document.getElementById('overlay-canvas').getContext('2d').clearRect(0,0,300,400);
            const reader = new FileReader();
            reader.onload = (e) => {
                userImage.src = e.target.result;
                userImage.style.display = 'block';
                if(photoControls) photoControls.style.display = 'block';
                if(analyzeBtn) analyzeBtn.style.display = 'block';
                document.getElementById('size-slider').value = 80;
                userImage.style.width = '80%';
                document.getElementById('opacity-slider').value = 0.7;
                userImage.style.opacity = '0.7';
                document.getElementById('guideline-size-slider').value = 100;
                updateGuidelineSize(100);
            };
            reader.readAsDataURL(file);
        });
    }

    const sizeSlider = document.getElementById('size-slider');
    const opacitySlider = document.getElementById('opacity-slider');
    if (sizeSlider) {
        sizeSlider.addEventListener('input', (e) => { if(userImage) userImage.style.width = `${e.target.value}%`; });
    }
    if (opacitySlider) {
        opacitySlider.addEventListener('input', (e) => { if(userImage) userImage.style.opacity = e.target.value; });
    }
    
    const guidelineSVG = document.getElementById('guideline-svg');
    const ovalGuide = document.getElementById('oval-guide');
    const redLine = document.getElementById('red-line');
    const blueLine = document.getElementById('blue-line');
    const greenLines = guidelineSVG.querySelectorAll('.green-line');
    const draggableLineVisual = document.getElementById('draggable-line-visual');
    const draggableLineHandle = document.getElementById('draggable-line-handle');
    const guidelineSizeSlider = document.getElementById('guideline-size-slider');
    const IDEAL_ASPECT_RATIO = 1.3;
    
    function updateGuidelineSize(sizePercent) {
        const svgWidth = 300;
        const baseRx = svgWidth / 3; 
        const rx = baseRx * (sizePercent / 100);
        const ry = rx * IDEAL_ASPECT_RATIO;
        ovalGuide.setAttribute('rx', rx);
        ovalGuide.setAttribute('ry', ry);
        redLine.setAttribute('x1', 150 - rx);
        redLine.setAttribute('x2', 150 + rx);
        blueLine.setAttribute('y1', 200 - ry);
        blueLine.setAttribute('y2', 200 + ry);
        const sectionWidth = (rx * 2) / 4;
        const startX = 150 - rx;
        greenLines.forEach((line, index) => {
            const xPos = startX + (sectionWidth * (index + 1));
            line.setAttribute('x1', xPos);
            line.setAttribute('x2', xPos);
            line.setAttribute('y1', 200 - ry);
            line.setAttribute('y2', 200 + ry);
        });
        draggableLineVisual.setAttribute('x1', 150 - rx);
        draggableLineVisual.setAttribute('x2', 150 + rx);
        draggableLineHandle.setAttribute('x1', 150 - rx);
        draggableLineHandle.setAttribute('x2', 150 + rx);
    }
    if(guidelineSizeSlider) {
        guidelineSizeSlider.addEventListener('input', (e) => {
            updateGuidelineSize(e.target.value);
        });
    }
    updateGuidelineSize(100);
    
    let isImageDragging = false;
    let isLineDragging = false;
    let startX, startY, initialLeft, initialTop;
    if (guideContainer) {
        guideContainer.addEventListener('mousedown', e => {
            if (e.target.id === 'draggable-line-handle') {
                isLineDragging = true;
                if(guidelineSVG) guidelineSVG.style.pointerEvents = 'all';
                return;
            }
            if (!userImage.src || userImage.style.display === 'none') return;
            e.preventDefault();
            isImageDragging = true;
            userImage.style.cursor = 'grabbing';
            startX = e.clientX;
            startY = e.clientY;
            initialLeft = userImage.offsetLeft;
            initialTop = userImage.offsetTop;
        });
    }
    window.addEventListener('mousemove', (e) => {
        if (isLineDragging && guidelineSVG) {
            const CTM = guidelineSVG.getScreenCTM().inverse();
            const pt = guidelineSVG.createSVGPoint();
            pt.x = e.clientX;
            pt.y = e.clientY;
            const svgP = pt.matrixTransform(CTM);
            draggableLineVisual.setAttribute('y1', svgP.y);
            draggableLineVisual.setAttribute('y2', svgP.y);
            draggableLineHandle.setAttribute('y1', svgP.y);
            draggableLineHandle.setAttribute('y2', svgP.y);
            return;
        }
        if (isImageDragging && userImage) {
            userImage.style.left = `${initialLeft + (e.clientX - startX)}px`;
            userImage.style.top = `${initialTop + (e.clientY - startY)}px`;
        }
    });
    window.addEventListener('mouseup', () => {
        if(isLineDragging) {
            isLineDragging = false;
            if(guidelineSVG) guidelineSVG.style.pointerEvents = 'none';
        }
        if(isImageDragging) {
            isImageDragging = false;
            if(userImage) userImage.style.cursor = 'grab';
        }
    });

    async function analyzePhoto() {
        if (!modelsLoaded) { alert("ë¶„ì„ ëª¨ë¸ì´ ì•„ì§ ë¡œë”© ì¤‘ì…ë‹ˆë‹¤."); return; }
        if (!userImage.src || userImage.style.display === 'none') { alert("ë¨¼ì € ì‚¬ì§„ì„ ì„ íƒí•´ì£¼ì„¸ìš”."); return; }
        if(loader) loader.style.display = 'block';
        if(analyzeBtn) analyzeBtn.style.display = 'none';
        try {
            const detection = await faceapi.detectSingleFace(userImage, new faceapi.SsdMobilenetv1Options()).withFaceLandmarks();
            if (!detection) {
                if(loader) loader.style.display = 'none';
                if(analyzeBtn) analyzeBtn.style.display = 'block';
                alert("ì–¼êµ´ì„ ì¸ì‹í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë” ì„ ëª…í•˜ê³  ì •ë©´ì„ ë°”ë¼ë³´ëŠ” ì‚¬ì§„ì„ ì‚¬ìš©í•´ì£¼ì„¸ìš”.");
                return;
            }
            const canvas = document.getElementById('overlay-canvas');
            const ctx = canvas.getContext('2d');
            const imageRect = userImage.getBoundingClientRect();
            const containerRect = guideContainer.getBoundingClientRect();
            canvas.style.top = `${imageRect.top - containerRect.top}px`;
            canvas.style.left = `${imageRect.left - containerRect.left}px`;
            canvas.style.width = `${imageRect.width}px`;
            canvas.style.height = `${imageRect.height}px`;
            canvas.width = imageRect.width;
            canvas.height = imageRect.height;
            const displaySize = { width: imageRect.width, height: imageRect.height };
            const resizedDetections = faceapi.resizeResults(detection, displaySize);
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            faceapi.draw.drawFaceLandmarks(canvas, resizedDetections);
            const landmarks = detection.landmarks;
            const jaw = landmarks.getJawOutline();
            const leftEye = landmarks.getLeftEye();
            const rightEye = landmarks.getRightEye();

            let score = 0;
            const faceHeight = jaw[8].y - (jaw[0].y + jaw[16].y) / 2;
            const faceWidth = jaw[16].x - jaw[0].x;
            const aspectRatio = faceHeight / faceWidth;
            if (aspectRatio > 1.3) score++;
            const leftEyeCenterY = (leftEye[1].y + leftEye[2].y + leftEye[4].y + leftEye[5].y) / 4;
            const leftEyebrowY = (landmarks.getLeftEyeBrow()[0].y + landmarks.getLeftEyeBrow()[1].y + landmarks.getLeftEyeBrow()[2].y + landmarks.getLeftEyeBrow()[3].y + landmarks.getLeftEyeBrow()[4].y) / 5;
            const eyeToEyebrowDistance = leftEyeCenterY - leftEyebrowY;
            const leftEyeHeight = (leftEye[4].y + leftEye[5].y) / 2 - (leftEye[1].y + leftEye[2].y) / 2;
            const normalizedDistance = eyeToEyebrowDistance / leftEyeHeight;
            if (normalizedDistance > 1.0) score++;
            const step1 = (score >= 1) ? 'A' : 'B';
            
            const p1 = jaw[2], p2 = jaw[4], p3 = jaw[8];
            const v1 = { x: p1.x - p2.x, y: p1.y - p2.y };
            const v2 = { x: p3.x - p2.x, y: p3.y - p2.y };
            const dotProduct = v1.x * v2.x + v1.y * v2.y;
            const magnitude1 = Math.sqrt(v1.x**2 + v1.y**2), magnitude2 = Math.sqrt(v2.x**2 + v2.y**2);
            const jawAngle = Math.acos(dotProduct / (magnitude1 * magnitude2)) * (180 / Math.PI);
            const step2 = (jawAngle < 145) ? 'D' : 'C';
            
            const leftEyeWidth = leftEye[3].x - leftEye[0].x;
            const step3 = (leftEyeWidth / leftEyeHeight < 3.0) ? 'E' : 'F';
            
            const midEyesX = (leftEye[0].x + rightEye[3].x) / 2;
            const eyeSpreadRatio = Math.abs(midEyesX - landmarks.getNose()[0].x) / faceWidth;
            const step4 = (eyeSpreadRatio < 0.03) ? 'A' : 'B';
            
            const step5 = (aspectRatio < 1.2) ? 'C' : 'D';
            
            const step6 = (step4 === 'A' || step2 === 'C') ? 'E' : 'F';
            
            const analysisResult = { step1, step2, step3, step4, step5, step6 };
            displayResults(analysisResult, true); // ì‚¬ì§„ ë¶„ì„ì„ì„ ì•Œë¦¼
            showPage('result-page');
        } catch (error) {
            console.error("ì‚¬ì§„ ë¶„ì„ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
            alert("ì‚¬ì§„ì„ ë¶„ì„í•˜ëŠ” ì¤‘ì— ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ë¥¸ ì‚¬ì§„ìœ¼ë¡œ ì‹œë„í•´ë³´ê±°ë‚˜, ì„¤ë¬¸ìœ¼ë¡œ ì§„ë‹¨í•˜ëŠ” ë°©ë²•ì„ ì´ìš©í•´ì£¼ì„¸ìš”.");
        } finally {
            if(loader) loader.style.display = 'none';
            if(analyzeBtn) analyzeBtn.style.display = 'block';
        }
    }

    function analyzeQuiz() {
        const form = document.getElementById('quiz-form');
        const analysisResult = {
            step1: form.elements['q1'].value,
            step2: form.elements['q2'].value,
            step3: form.elements['q3'].value,
            step4: form.elements['q4'].value,
            step5: form.elements['q5'].value,
            step6: form.elements['q6'].value,
        };
        if (Object.values(analysisResult).some(v => !v)) {
            alert("ëª¨ë“  ì§ˆë¬¸ì— ë‹µë³€í•´ì£¼ì„¸ìš”!");
            return;
        }
        displayResults(analysisResult, false); // ì„¤ë¬¸ ë¶„ì„ì„ì„ ì•Œë¦¼
        showPage('result-page');
    }

    function displayResults(analysis, fromPhoto = false) {
        const content = document.getElementById('result-content');
        if (!content) return;

        // ì¶”ì²œ ë©˜íŠ¸ í…ìŠ¤íŠ¸
        const resultTexts = {
            step1: { A: "ë„í†°í•œ", B: "ì–‡ì€" },
            step2: { C: "ì‚°ì´ ì—†ëŠ” ë¶€ë“œëŸ¬ìš´ ê³¡ì„  í˜•íƒœ", D: "ì‚°ì´ ìˆëŠ” ì§ì„ ì ì´ê³  ê°ì§„ í˜•íƒœ" },
            step3: { E: "ì•„ë˜ìª½ì„ ì•„ì¹˜ì²˜ëŸ¼ íŒŒì£¼ëŠ” ê³¡ì„ í˜•", F: "ì•„ë˜ìª½ì´ ì™„ë§Œí•œ ì¼ìí˜•" },
            step4: { A: "ì‚°ì´ ê¸¸ê³  ê¼¬ë¦¬ê°€ ì§§ì€ í˜•íƒœ", B: "ì‚°ì´ ì§§ê³  ê¼¬ë¦¬ê°€ ê¸´ í˜•íƒœ" },
            step5: { C: "ì–¼êµ´ì´ ëœ ë™ê·¸ë˜ ë³´ì´ë„ë¡ ì¡°ê¸ˆ ê¸¸ê²Œ", D: "ì–¼êµ´ì˜ ì„¸ë¡œ ê¸¸ì´ë¥¼ ë³´ì™„í•˜ë„ë¡ ì¡°ê¸ˆ ì§§ê²Œ" },
            step6: { E: "ì˜…ê³  ë¶€ë“œëŸ½ê²Œ í‘œí˜„í•˜ëŠ”", F: "ë˜ë ·í•˜ê³  ê²°ì„ ì‚´ë ¤ í‘œí˜„í•˜ëŠ”" }
        };

        // [ì¶”ê°€] ì‚¬ì§„ ë¶„ì„ ì‹œ ë³´ì—¬ì¤„ ê·¼ê±° í…ìŠ¤íŠ¸
        const photoBasisTexts = {
            step1: { A: "ì–¼êµ´ì´ ê¸¸ê±°ë‚˜ ëˆˆê³¼ ëˆˆì¹ ì‚¬ì´ê°€ ë¨¼ í¸", B: "ì–¼êµ´ì´ ì§§ê±°ë‚˜ ëˆˆê³¼ ëˆˆì¹ ì‚¬ì´ê°€ ì¢ì€ í¸" },
            step2: { C: "í„±ì„ ì´ 145ë„ ì´ìƒìœ¼ë¡œ ë¶€ë“œëŸ¬ìš´ í¸", D: "í„±ì„ ì´ 145ë„ ë¯¸ë§Œìœ¼ë¡œ ê°ì§„ í¸" },
            step3: { E: "ëˆˆì˜ ì„¸ë¡œ ë¹„ìœ¨ì´ ë†’ì•„ ë™ê·¸ë€ í¸", F: "ëˆˆì˜ ê°€ë¡œ ë¹„ìœ¨ì´ ë†’ì•„ ê¸´ í¸" },
            step4: { A: "ì´ëª©êµ¬ë¹„ê°€ ì¤‘ì•™ì— ëª¨ì—¬ìˆëŠ” í¸", B: "ì´ëª©êµ¬ë¹„ê°€ ë°”ê¹¥ìœ¼ë¡œ í¼ì ¸ìˆëŠ” í¸" },
            step5: { C: "ì–¼êµ´ ì„¸ë¡œ/ê°€ë¡œ ë¹„ìœ¨ì´ 1.2 ë¯¸ë§Œìœ¼ë¡œ ë™ê·¸ë€ í¸", D: "ì–¼êµ´ ì„¸ë¡œ/ê°€ë¡œ ë¹„ìœ¨ì´ 1.2 ì´ìƒìœ¼ë¡œ ê¸´ í¸" },
            step6: { E: "ë¶€ë“œëŸ¬ìš´ ì¸ìƒ(ë‚´ì‹¬ì•ˆ ë˜ëŠ” ë‘¥ê·¼ í„±)", F: "ë˜ë ·í•œ ì¸ìƒ(ì™¸ì‹¬ì•ˆ ë˜ëŠ” ê°ì§„ í„±)" }
        };

        let title, intro, outro;
        if (analysis.step2 === 'C') {
            title = `ë‹¹ì‹ ì˜ ë§¤ë ¥ì„ ê·¹ëŒ€í™”í•  "<strong>ë¶€ë“œëŸ½ê³  ì²­ìˆœí•œ ë™ì•ˆ ëˆˆì¹</strong>"`;
            intro = "ì¶•í•˜ë“œë¦½ë‹ˆë‹¤! ë‹¹ì‹ ì€ ë¶€ë“œëŸ½ê³  ì²­ìˆœí•˜ë©° ì–´ë ¤ ë³´ì´ëŠ” ë™ì•ˆ ì¸ìƒì„ ê°€ì¥ ì˜ ì–´í•„í•  ìˆ˜ ìˆëŠ” íƒ€ì…ì…ë‹ˆë‹¤. ë‹¹ì‹ ì˜ ë§¤ë ¥ì„ ë”ìš± ë‹ë³´ì´ê²Œ í•  ëˆˆì¹ì€ ê³¼ë„í•œ ê° ì—†ì´ ë¶€ë“œëŸ¬ìš´ ê³¡ì„  í˜•íƒœë¥¼ ìœ ì§€í•˜ë©°, ì „ì²´ì ìœ¼ë¡œ ì™„ë§Œí•˜ê³  ìì—°ìŠ¤ëŸ¬ìš´ íë¦„ì„ ê°€ì§€ëŠ” ê²ƒì´ í•µì‹¬ì…ë‹ˆë‹¤.";
            outro = "ì´ ëª¨ë“  ìš”ì†Œë¥¼ ì¢…í•©í•˜ì—¬ ë‹¹ì‹ ì˜ ì–¼êµ´ì— ì°°ë–¡ê°™ì´ ì–´ìš¸ë¦¬ëŠ” ëˆˆì¹ì„ ì™„ì„±í•´ ë³´ì„¸ìš”. ìì—°ìŠ¤ëŸ¬ìš´ ì•„ë¦„ë‹¤ì›€ìœ¼ë¡œ ë‹¹ì‹ ì˜ ì²­ìˆœí•˜ê³  ê·€ì—¬ìš´ ë§¤ë ¥ì„ í•œê» ë½ë‚¼ ìˆ˜ ìˆì„ ê²ƒì…ë‹ˆë‹¤!";
        } else {
            title = `ë‹¹ì‹ ì˜ í’ˆê²©ì„ ë†’ì¼ "<strong>ì„¸ë ¨ë˜ê³  ëšœë ·í•œ ì„±ìˆ™ ëˆˆì¹</strong>"`;
            intro = "ì¶•í•˜ë“œë¦½ë‹ˆë‹¤! ë‹¹ì‹ ì€ ì„¸ë ¨ë˜ê³  ëšœë ·í•˜ë©° ê³ ê¸‰ìŠ¤ëŸ¬ìš´ ì„±ìˆ™í•œ ì¸ìƒì„ ê°€ì¥ ì˜ ë‚˜íƒ€ë‚¼ ìˆ˜ ìˆëŠ” íƒ€ì…ì…ë‹ˆë‹¤. ë‹¹ì‹ ì˜ ë§¤ë ¥ì„ ë”ìš± ê°•ì¡°í•  ëˆˆì¹ì€ ì§ì„ ì ì¸ ìš”ì†Œë¥¼ í™œìš©í•˜ì—¬ ë˜ë ·í•œ ì¸ìƒì„ ë¶€ì—¬í•˜ê³ , ì ì ˆí•œ ì‚°ì„ í†µí•´ ì…ì²´ê°ê³¼ ì‹œì›í•¨ì„ ë”í•˜ëŠ” ê²ƒì´ ì¤‘ìš”í•©ë‹ˆë‹¤.";
            outro = "ì´ ëª¨ë“  ìš”ì†Œë¥¼ ì¢…í•©í•˜ì—¬ ë‹¹ì‹ ì˜ ì–¼êµ´ì— ì°°ë–¡ê°™ì´ ì–´ìš¸ë¦¬ëŠ” ëˆˆì¹ì„ ì™„ì„±í•´ ë³´ì„¸ìš”. ë‹¹ì‹ ì˜ ì„¸ë ¨ë˜ê³  ê°•ë ¬í•œ ë§¤ë ¥ì„ ë”ìš± ë¹›ë‚˜ê²Œ í•  ê²ƒì…ë‹ˆë‹¤!";
        }
        
        let listItemsHTML = '';
        for (let i = 1; i <= 6; i++) {
            const stepKey = `step${i}`;
            const analysisResult = analysis[stepKey];
            const recommendationText = resultTexts[stepKey][analysisResult];
            
            // ì‚¬ì§„ ë¶„ì„ì¼ ê²½ìš°ì—ë§Œ ê·¼ê±° í…ìŠ¤íŠ¸ ì¶”ê°€
            const basisText = fromPhoto ? `<span class="photo-basis">(ì‚¬ì§„ ë¶„ì„: ${photoBasisTexts[stepKey][analysisResult]})</span>` : '';
            
            const stepTitles = ["ë‘ê»˜:", "ìœ„ìª½ ëª¨ì–‘:", "ì•„ë˜ìª½ ëª¨ì–‘:", "ì‚°/ê¼¬ë¦¬ ê¸¸ì´:", "ì „ì²´ ê¸¸ì´:", "ì•ë¨¸ë¦¬:"];
            const stepSuffix = (i === 1) ? " ëˆˆì¹" : (i === 5) ? " ê·¸ë¦¬ëŠ” ëˆˆì¹" : (i === 6) ? " ì•ë¨¸ë¦¬" : "";

            listItemsHTML += `
                <li>
                    <strong>${stepTitles[i-1]}</strong> ${recommendationText}${stepSuffix}
                    ${basisText}
                </li>
            `;
        }

        const resultHTML = `
            <div class="result-card">
                <h3>${title}</h3>
                <p>${intro}</p>
                <br>
                <h4>ë‹¹ì‹ ì—ê²Œ ì œì•ˆí•˜ëŠ” ëˆˆì¹ì˜ ì£¼ìš” íŠ¹ì§•:</h4>
                <ul>
                    ${listItemsHTML}
                </ul>
                <br>
                <p>${outro}</p>
            </div>
        `;
        content.innerHTML = resultHTML;
    }
</script>
</body>
</html>
