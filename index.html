<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>çœ‰ì™„ì„±: ë‚´ ì¸ìƒ ëˆˆì¹ ì°¾ê¸°</title>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <style>
        :root {
            --primary-color: #6a5acd; /* SlateBlue */
            --secondary-color: #f0e6ff;
            --text-color: #333;
            --bg-color: #f8f9fa;
            --container-bg: #ffffff;
            --border-radius: 16px;
            --shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            box-sizing: border-box;
            color: var(--text-color);
        }
        .main-container {
            width: 100%;
            max-width: 500px;
            background-color: var(--container-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 25px;
            box-sizing: border-box;
            text-align: center;
        }
        h1, h2, h3, h4 {
            margin: 0 0 15px;
            color: var(--primary-color);
        }
        h1 { font-size: 2rem; }
        h2 { font-size: 1.6rem; }
        h4 { font-size: 1.1rem; margin-top: 20px;}
        p { line-height: 1.7; margin: 0 0 20px; }
        .btn {
            display: block; width: 100%; padding: 15px; margin: 10px 0;
            border: none; border-radius: 12px; background-color: var(--primary-color);
            color: white; font-size: 1.1rem; font-weight: bold; cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
        }
        .btn:hover { background-color: #5a4ab9; }
        .btn:active { transform: scale(0.98); }
        .btn.secondary {
             background-color: #e9ecef; color: var(--text-color);
        }
        #photo-page .btn.secondary {
            display: inline-block;
            width: auto;
            padding: 15px 30px;
        }
        .btn.secondary:hover { background-color: #d3d9df; }
        .page { display: none; }
        .page.active { display: block; }
        #guide-container {
            width: 100%; aspect-ratio: 3 / 4; background-color: #e9ecef;
            border: 2px dashed #ced4da; border-radius: 12px;
            position: relative; overflow: hidden; user-select: none; margin: 20px 0;
        }
        #user-image, #overlay-canvas, #guideline-svg {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            max-width: 100%; max-height: 100%;
            height: auto; width: 80%;
        }
        #user-image { z-index: 10; cursor: grab; }
        #user-image:active { cursor: grabbing; }
        #guideline-svg { z-index: 20; pointer-events: none; }
        #overlay-canvas { z-index: 30; pointer-events: none; }
        #guideline-svg .draggable-line {
            pointer-events: all;
            cursor: ns-resize;
            stroke-width: 8px;
            stroke: rgba(0,0,0,0);
        }
        .sliders {
            margin-top: 20px; padding: 20px;
            background-color: #f8f9fa; border-radius: 8px;
        }
        .slider-group {
            display: flex; align-items: center;
            gap: 15px; margin-bottom: 15px;
        }
        .slider-group label { font-size: 14px; width: 100px; text-align: left;}
        input[type="range"] { flex-grow: 1; }
        .description-text {
            font-size: 0.8em; color: #888; text-align: left;
            padding-left: 10px; border-left: 3px solid #e0e0e0;
        }
        .question { margin-bottom: 30px; text-align: left; }
        .question p { font-weight: 500; margin-bottom: 15px; }
        .options { display: flex; flex-direction: column; gap: 10px; }
        .result-card {
            background-color: var(--secondary-color); border-radius: 12px;
            padding: 20px; margin-bottom: 15px; text-align: left;
        }
        .result-card h3 { color: var(--primary-color); border-bottom: 2px solid var(--primary-color); padding-bottom: 10px; margin-bottom: 15px;}
        .result-card ul { padding-left: 20px; margin: 0; list-style-type: none;}
        .result-card li { margin-bottom: 12px; }
        .photo-basis {
            font-size: 0.8em;
            color: #666;
            display: block;
            padding-left: 10px;
            border-left: 2px solid var(--primary-color);
            margin-top: 5px;
        }
        #loader {
            border: 8px solid #f3f3f3; border-radius: 50%;
            border-top: 8px solid var(--primary-color);
            width: 60px; height: 60px;
            animation: spin 1s linear infinite; margin: 30px auto; display: none;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div class="main-container">

        <div id="start-page" class="page active">
            <h1>çœ‰ì™„ì„±</h1>
            <p><strong>ë‚´ ì–¼êµ´ì— ë”± ë§ëŠ” ì¸ìƒ ëˆˆì¹ì„ ì°¾ì•„ë³´ì„¸ìš”!</strong><br>ë‘ ê°€ì§€ ë°©ë²• ì¤‘ í•˜ë‚˜ë¥¼ ì„ íƒí•´ ì§„ë‹¨ì„ ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
            <button class="btn" onclick="showPage('photo-page')">ğŸ“¸ ì‚¬ì§„ìœ¼ë¡œ ë¶„ì„í•˜ê¸°</button>
            <button class="btn" onclick="showPage('quiz-page')">âœï¸ ì„¤ë¬¸ìœ¼ë¡œ ì§„ë‹¨í•˜ê¸°</button>
            <p style="font-size: 0.8em; color: #888; margin-top: 20px;">
                ì‚¬ì§„ì€ ì„œë²„ì— ì €ì¥ë˜ì§€ ì•Šìœ¼ë©°, ë¶„ì„ì€ ëª¨ë‘ ì‚¬ìš©ìì˜ ê¸°ê¸°ì—ì„œë§Œ ì´ë£¨ì–´ì§‘ë‹ˆë‹¤.
            </p>
        </div>

        <div id="photo-page" class="page">
            <h2>ì‚¬ì§„ìœ¼ë¡œ ë¶„ì„í•˜ê¸°</h2>
            <p>ì •ë©´ì„ ë°”ë¼ë³´ëŠ” ì„ ëª…í•œ ì‚¬ì§„ì„ ì˜¬ë¦¬ê³ <br>ê°€ì´ë“œë¼ì¸ì— ë§ì¶° ì–¼êµ´ì„ ì¡°ì •í•´ì£¼ì„¸ìš”.</p>
            
            <label for="file-input" class="btn secondary">ğŸ–¼ï¸ ì‚¬ì§„ ì„ íƒ</label>
            <input type="file" id="file-input" accept="image/*" style="display:none;">

            <div id="guide-container">
                <svg id="guideline-svg" viewbox="0 0 300 400" preserveAspectRatio="xMidYMid meet">
                    <ellipse id="oval-guide" cx="150" cy="200" rx="100" ry="130" stroke="rgba(0,0,0,0.5)" stroke-width="2" stroke-dasharray="5,5" fill="none" />
                    <line id="red-line" x1="50" y1="200" x2="250" y2="200" stroke="red" stroke-width="1.5" />
                    <line id="blue-line" x1="150" y1="70" x2="150" y2="330" stroke="blue" stroke-width="1.5" />
                    <line class="green-line" x1="116.67" y1="70" x2="116.67" y2="330" stroke="green" stroke-width="1" />
                    <line class="green-line" x1="183.33" y1="70" x2="183.33" y2="330" stroke="green" stroke-width="1" />
                    <line id="draggable-line-visual" x1="50" y1="220" x2="250" y2="220" stroke="skyblue" stroke-width="2" />
                    <line class="draggable-line" id="draggable-line-handle" x1="50" y1="220" x2="250" y2="220" />
                </svg>
                <img id="user-image" src="" alt="User's face" style="display:none;">
                <canvas id="overlay-canvas"></canvas>
            </div>

            <div id="photo-controls" style="display:none;">
                <div class="sliders">
                    <p class="description-text"><strong>ì‚¬ì§„ ì¡°ì ˆ</strong></p>
                    <div class="slider-group">
                        <label for="size-slider">ì‚¬ì§„ í¬ê¸°</label>
                        <input type="range" id="size-slider" min="10" max="250" value="80">
                    </div>
                    <div class="slider-group">
                        <label for="opacity-slider">ì‚¬ì§„ íˆ¬ëª…ë„</label>
                        <input type="range" id="opacity-slider" min="0" max="1" step="0.05" value="0.7">
                    </div>
                </div>
                <div class="sliders">
                    <p class="description-text"><strong>ê°€ì´ë“œë¼ì¸ ì¡°ì ˆ</strong></p>
                    <div class="slider-group">
                        <label for="guideline-size-slider">ì „ì²´ í¬ê¸°</label>
                        <input type="range" id="guideline-size-slider" min="50" max="150" value="100">
                    </div>
                    <p class="description-text" style="font-size:0.75em; margin-top: 5px;">
                        ê°€ì´ë“œë¼ì¸ì„ ì¡°ì ˆí•˜ì—¬ ì–¼êµ´ ë¹„ìœ¨ì„ ì§ì ‘ í™•ì¸í•´ë³´ì„¸ìš”.
                    </p>
                </div>
            </div>
            
            <p class="description-text" style="margin-top:15px; font-size: 0.9em;">
                <strong>ë™ê·¸ë€ ì–¼êµ´:</strong> ì–¼êµ´ì˜ ê°€ë¡œì™€ ì„¸ë¡œ ê¸¸ì´ê°€ 1:1.1 ì •ë„ë¡œ ë¹„ìŠ·<br>
                <strong>íƒ€ì›í˜• ì–¼êµ´:</strong> ê°€ë¡œë³´ë‹¤ ì„¸ë¡œ ê¸¸ì´ê°€ 1:1.4 ì´ìƒìœ¼ë¡œ í›¨ì”¬ ê¹€
            </p>
            
            <div id="loader"></div>
            <button class="btn" id="analyze-btn" onclick="analyzePhoto()" style="display:none;">ê²°ê³¼ ë¶„ì„í•˜ê¸°</button>
            <button class="btn secondary" onclick="showPage('start-page')">ë’¤ë¡œ ê°€ê¸°</button>
        </div>

        <div id="quiz-page" class="page">
            <h2>ì„¤ë¬¸ìœ¼ë¡œ ì§„ë‹¨í•˜ê¸°</h2>
            <p>ì•„ë˜ ì§ˆë¬¸ì— ë‹µí•˜ì—¬<br>ìì‹ ì—ê²Œ ê¼­ ë§ëŠ” ëˆˆì¹ ìŠ¤íƒ€ì¼ì„ ì°¾ì•„ë³´ì„¸ìš”.</p>
            <form id="quiz-form">
                <div class="question">
                    <p>1. ë‚´ ì–¼êµ´ì˜ íŠ¹ì§•ì€ ì–´ë””ì— ê°€ê¹ë‚˜ìš”?</p>
                    <div class="options">
                        <label><input type="radio" name="q1" value="A"> ì–¼êµ´ì´ ê¸¸ê±°ë‚˜, ëˆˆê³¼ ëˆˆì¹ ì‚¬ì´ê°€ ë©€ë‹¤.</label>
                        <label><input type="radio" name="q1" value="B"> ì–¼êµ´ì´ ì§§ê±°ë‚˜, ëˆˆê³¼ ëˆˆì¹ ì‚¬ì´ê°€ ì¢ë‹¤.</label>
                    </div>
                </div>
                <div class="question">
                    <p>2. ë‚˜ì˜ ì „ì²´ì ì¸ ì¸ìƒì´ë‚˜ ì–¼êµ´ ë¼ì¸ì€?</p>
                    <div class="options">
                        <label><input type="radio" name="q2" value="C"> ì–¼êµ´ì„ ì´ ë‘¥ê¸€ê³ , ì²­ìˆœí•˜ê³  ë¶€ë“œëŸ¬ìš´ ì¸ìƒì´ë‹¤.</label>
                        <label><input type="radio" name="q2" value="D"> ì–¼êµ´ì„ ì´ ê°ì§€ê³ , ì„¸ë ¨ë˜ê³  ë˜ë ·í•œ ì¸ìƒì´ë‹¤.</label>
                    </div>
                </div>
                <div class="question">
                    <p>3. ë‚´ ëˆˆ ëª¨ì–‘ì€ ì–´ë–¤ê°€ìš”?</p>
                    <div class="options">
                        <label><input type="radio" name="q3" value="E"> ëˆˆì´ ì „ì²´ì ìœ¼ë¡œ ë™ê·¸ë€ í¸ì´ë‹¤.</label>
                        <label><input type="radio" name="q3" value="F"> ëˆˆì´ ê°€ë¡œë¡œ ê¸´ í¸ì´ë‹¤.</label>
                    </div>
                </div>
                <div class="question">
                    <p>4. ë‚´ ì´ëª©êµ¬ë¹„ëŠ” ì–¼êµ´ ì¤‘ì•™ì— ëª¨ì—¬ìˆëŠ” í¸ì¸ê°€ìš”?</p>
                    <div class="options">
                        <label><input type="radio" name="q4" value="A"> ì´ëª©êµ¬ë¹„ê°€ ì¤‘ì•™ì— ëª¨ì—¬ìˆê³ , ëˆˆ ì‚¬ì´ê°€ ê°€ê¹ë‹¤ (ë‚´ì‹¬ì•ˆ).</label>
                        <label><input type="radio" name="q4" value="B"> ì´ëª©êµ¬ë¹„ê°€ ë„“ê²Œ í¼ì ¸ìˆê³ , ëˆˆ ì‚¬ì´ê°€ ë©€ë‹¤ (ì™¸ì‹¬ì•ˆ).</label>
                    </div>
                </div>
                <div class="question">
                    <p>5. ë‚´ ì–¼êµ´ì˜ ê°€ë¡œ/ì„¸ë¡œ ë¹„ìœ¨ì€ ì–´ë–¤ê°€ìš”?</p>
                    <div class="options">
                        <label><input type="radio" name="q5" value="C"> ê°€ë¡œ ëŒ€ë¹„ ì„¸ë¡œ ê¸¸ì´ê°€ ì§§ì€ ë™ê·¸ë€ ì–¼êµ´í˜•ì´ë‹¤.</label>
                        <label><input type="radio" name="q5" value="D"> ê°€ë¡œ ëŒ€ë¹„ ì„¸ë¡œ ê¸¸ì´ê°€ ê¸´ íƒ€ì›í˜•/ê¸´ ì–¼êµ´í˜•ì´ë‹¤.</label>
                    </div>
                </div>
                <div class="question">
                    <p>6. ë‚˜ì˜ ë¯¸ê°„ ë„ˆë¹„ì™€ ì¶”êµ¬í•˜ëŠ” ì¸ìƒì€?</p>
                    <div class="options">
                        <label><input type="radio" name="q6" value="E"> ë¯¸ê°„ì´ ì¢ì€ í¸ì´ë©°, ë¶€ë“œëŸ¬ìš´ ì¸ìƒì„ ì›í•œë‹¤.</label>
                        <label><input type="radio" name="q6" value="F"> ë¯¸ê°„ì´ ë„“ì€ í¸ì´ë©°, ë˜ë ·í•œ ì¸ìƒì„ ì›í•œë‹¤.</label>
                    </div>
                </div>
                <button type="button" class="btn" onclick="analyzeQuiz()">ê²°ê³¼ í™•ì¸í•˜ê¸°</button>
                <button type="button" class="btn secondary" onclick="showPage('start-page')">ë’¤ë¡œ ê°€ê¸°</button>
            </form>
        </div>

        <div id="result-page" class="page">
            <h2>ì§„ë‹¨ ê²°ê³¼ ğŸ§</h2>
            <p>ë‹¹ì‹ ì—ê²Œ ì–´ìš¸ë¦¬ëŠ” ìµœê³ ì˜ ëˆˆì¹ ìŠ¤íƒ€ì¼ì„ ì¶”ì²œí•©ë‹ˆë‹¤!</p>
            <div id="result-content"></div>
            <button class="btn" onclick="showPage('start-page')">ë‹¤ì‹œ í•˜ê¸°</button>
        </div>
        
    </div>

<script>
    const pages = document.querySelectorAll('.page');
    const loader = document.getElementById('loader');
    let modelsLoaded = false;

    function showPage(pageId) {
        pages.forEach(page => page.classList.remove('active'));
        const targetPage = document.getElementById(pageId);
        if (targetPage) {
            targetPage.classList.add('active');
        }
        if (pageId === 'start-page') {
            const fileInput = document.getElementById('file-input');
            const userImage = document.getElementById('user-image');
            const photoControls = document.getElementById('photo-controls');
            const analyzeBtn = document.getElementById('analyze-btn');
            const canvas = document.getElementById('overlay-canvas');
            if(fileInput) fileInput.value = '';
            if(userImage) { userImage.src = ''; userImage.style.display = 'none'; }
            if(photoControls) photoControls.style.display = 'none';
            if(analyzeBtn) analyzeBtn.style.display = 'none';
            if(canvas) { canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height); }
            const quizForm = document.getElementById('quiz-form');
            if(quizForm) quizForm.reset();
        }
    }

    async function loadModels() {
        const MODEL_URL = './models'; // ëª¨ë¸ ê²½ë¡œ í™•ì¸ (ë¡œì»¬ì—ì„œ ì‹¤í–‰ ì‹œ)
        try {
            await faceapi.nets.ssdMobilenetv1.loadFromUri(MODEL_URL);
            await faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL);
            await faceapi.nets.ageGenderNet.loadFromUri(MODEL_URL); // ì„±ë³„/ë‚˜ì´ ì¸ì‹ ëª¨ë¸ ì¶”ê°€ (í•„ìˆ˜)
            modelsLoaded = true;
            console.log("ëª¨ë¸ ë¡œë”© ì™„ë£Œ!");
        } catch (error) {
            console.error("ëª¨ë¸ ë¡œë”© ì‹¤íŒ¨:", error);
            alert("ë¶„ì„ ëª¨ë¸ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. (ê²½ë¡œ í™•ì¸: " + MODEL_URL + ") ëª¨ë¸ íŒŒì¼ì´ models í´ë”ì— ì˜¬ë°”ë¥´ê²Œ ìœ„ì¹˜í•´ ìˆëŠ”ì§€, ë¡œì»¬ ì„œë²„ë¥¼ í†µí•´ ì ‘ê·¼í•˜ëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.");
        }
    }
    loadModels();

    const fileInput = document.getElementById('file-input');
    const userImage = document.getElementById('user-image');
    const photoControls = document.getElementById('photo-controls');
    const analyzeBtn = document.getElementById('analyze-btn');
    const guideContainer = document.getElementById('guide-container');

    if (fileInput) {
        fileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;
            document.getElementById('overlay-canvas').getContext('2d').clearRect(0,0,300,400);
            const reader = new FileReader();
            reader.onload = (e) => {
                userImage.src = e.target.result;
                userImage.style.display = 'block';
                if(photoControls) photoControls.style.display = 'block';
                if(analyzeBtn) analyzeBtn.style.display = 'block';
                document.getElementById('size-slider').value = 80;
                userImage.style.width = '80%';
                userImage.style.left = '50%';
                userImage.style.top = '50%';
                document.getElementById('opacity-slider').value = 0.7;
                userImage.style.opacity = '0.7';
                document.getElementById('guideline-size-slider').value = 100;
                updateGuidelineSize(100);
            };
            reader.readAsDataURL(file);
        });
    }

    const sizeSlider = document.getElementById('size-slider');
    const opacitySlider = document.getElementById('opacity-slider');
    if (sizeSlider) {
        sizeSlider.addEventListener('input', (e) => { if(userImage) userImage.style.width = `${e.target.value}%`; });
    }
    if (opacitySlider) {
        opacitySlider.addEventListener('input', (e) => { if(userImage) userImage.style.opacity = e.target.value; });
    }
    
    const guidelineSVG = document.getElementById('guideline-svg');
    const ovalGuide = document.getElementById('oval-guide');
    const redLine = document.getElementById('red-line');
    const blueLine = document.getElementById('blue-line');
    const greenLines = guidelineSVG.querySelectorAll('.green-line');
    const draggableLineVisual = document.getElementById('draggable-line-visual');
    const draggableLineHandle = document.getElementById('draggable-line-handle');
    const guidelineSizeSlider = document.getElementById('guideline-size-slider');
    const IDEAL_ASPECT_RATIO = 1.3;
    
    function updateGuidelineSize(sizePercent) {
        const svgWidth = 300;
        const baseRx = svgWidth / 3; 
        const rx = baseRx * (sizePercent / 100);
        const ry = rx * IDEAL_ASPECT_RATIO;

        ovalGuide.setAttribute('rx', rx);
        ovalGuide.setAttribute('ry', ry);
        
        redLine.setAttribute('x1', 150 - rx);
        redLine.setAttribute('x2', 150 + rx);
        blueLine.setAttribute('y1', 200 - ry);
        blueLine.setAttribute('y2', 200 + ry);
        
        const sectionWidth = (rx * 2) / 3;
        const startX = 150 - rx;
        greenLines[0].setAttribute('x1', startX + sectionWidth);
        greenLines[0].setAttribute('x2', startX + sectionWidth);
        greenLines[0].setAttribute('y1', 200 - ry);
        greenLines[0].setAttribute('y2', 200 + ry);
        
        greenLines[1].setAttribute('x1', startX + (sectionWidth * 2));
        greenLines[1].setAttribute('x2', startX + (sectionWidth * 2));
        greenLines[1].setAttribute('y1', 200 - ry);
        greenLines[1].setAttribute('y2', 200 + ry);

        draggableLineVisual.setAttribute('x1', 150 - rx);
        draggableLineVisual.setAttribute('x2', 150 + rx);
        draggableLineHandle.setAttribute('x1', 150 - rx);
        draggableLineHandle.setAttribute('x2', 150 + rx);
    }

    if(guidelineSizeSlider) {
        guidelineSizeSlider.addEventListener('input', (e) => {
            updateGuidelineSize(e.target.value);
        });
    }
    updateGuidelineSize(100);
    
    let isImageDragging = false;
    let isLineDragging = false;
    let startX_drag, startY_drag, initialLeft, initialTop;
    let initialLineY;
    
    if (guideContainer) {
        guideContainer.addEventListener('mousedown', e => {
            if (e.target.id === 'draggable-line-handle') {
                isLineDragging = true;
                initialLineY = parseFloat(draggableLineVisual.getAttribute('y1'));
                const CTM = guidelineSVG.getScreenCTM().inverse();
                const pt = guidelineSVG.createSVGPoint();
                pt.x = e.clientX;
                pt.y = e.clientY;
                startY_drag = pt.matrixTransform(CTM).y;
                return;
            }
            if (!userImage.src || userImage.style.display === 'none') return;
            e.preventDefault();
            isImageDragging = true;
            userImage.style.cursor = 'grabbing';
            startX_drag = e.clientX;
            startY_drag = e.clientY;
            initialLeft = userImage.offsetLeft;
            initialTop = userImage.offsetTop;
        });
    }
    window.addEventListener('mousemove', (e) => {
        if (isLineDragging && guidelineSVG) {
            const CTM = guidelineSVG.getScreenCTM().inverse();
            const pt = guidelineSVG.createSVGPoint();
            pt.x = e.clientX;
            pt.y = e.clientY;
            const svgP = pt.matrixTransform(CTM);
            
            const ovalRy = parseFloat(ovalGuide.getAttribute('ry'));
            const minY = 200 - ovalRy;
            const maxY = 200 + ovalRy;
            let newY = initialLineY + (svgP.y - startY_drag);
            
            newY = Math.max(minY, Math.min(maxY, newY));

            draggableLineVisual.setAttribute('y1', newY);
            draggableLineVisual.setAttribute('y2', newY);
            draggableLineHandle.setAttribute('y1', newY);
            draggableLineHandle.setAttribute('y2', newY);
            return;
        }
        if (isImageDragging && userImage) {
            const transform = window.getComputedStyle(userImage).transform;
            const matrix = new DOMMatrix(transform);
            const currentTranslateX = matrix.m41;
            const currentTranslateY = matrix.m42;

            const newTranslateX = currentTranslateX + (e.clientX - startX_drag);
            const newTranslateY = currentTranslateY + (e.clientY - startY_drag);

            userImage.style.transform = `translate(-50%, -50%) translate(${newTranslateX}px, ${newTranslateY}px)`;
            startX_drag = e.clientX;
            startY_drag = e.clientY;
        }
    });
    window.addEventListener('mouseup', () => {
        if(isLineDragging) {
            isLineDragging = false;
        }
        if(isImageDragging) {
            isImageDragging = false;
            if(userImage) userImage.style.cursor = 'grab';
            const transform = window.getComputedStyle(userImage).transform;
            const matrix = new DOMMatrix(transform);
            const translateX = matrix.m41;
            const translateY = matrix.m42;
            
            userImage.style.left = `calc(50% + ${translateX}px)`;
            userImage.style.top = `calc(50% + ${translateY}px)`;
            userImage.style.transform = 'translate(-50%, -50%)';
        }
    });

    async function analyzePhoto() {
        if (!modelsLoaded) { alert("ë¶„ì„ ëª¨ë¸ì´ ì•„ì§ ë¡œë”© ì¤‘ì…ë‹ˆë‹¤."); return; }
        if (!userImage.src || userImage.style.display === 'none') { alert("ë¨¼ì € ì‚¬ì§„ì„ ì„ íƒí•´ì£¼ì„¸ìš”."); return; }
        if(loader) loader.style.display = 'block';
        if(analyzeBtn) analyzeBtn.style.display = 'none';
        
        try {
            // ì„±ë³„/ë‚˜ì´ ì¸ì‹ ëª¨ë¸ì„ ë¡œë“œí–ˆìœ¼ë¯€ë¡œ withAgeAndGender() ì¶”ê°€
            const detection = await faceapi.detectSingleFace(userImage, new faceapi.SsdMobilenetv1Options())
                                        .withFaceLandmarks()
                                        .withAgeAndGender(); // ì„±ë³„/ë‚˜ì´ ì •ë³´ ì¶”ê°€

            if (!detection) {
                if(loader) loader.style.display = 'none';
                if(analyzeBtn) analyzeBtn.style.display = 'block';
                alert("ì–¼êµ´ì„ ì¸ì‹í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë” ì„ ëª…í•˜ê³  ì •ë©´ì„ ë°”ë¼ë³´ëŠ” ì‚¬ì§„ì„ ì‚¬ìš©í•´ì£¼ì„¸ìš”.");
                return;
            }
            
            const canvas = document.getElementById('overlay-canvas');
            const ctx = canvas.getContext('2d');
            
            const imageRect = userImage.getBoundingClientRect();
            const containerRect = guideContainer.getBoundingClientRect();

            canvas.style.top = `${imageRect.top - containerRect.top}px`;
            canvas.style.left = `${imageRect.left - containerRect.left}px`;
            canvas.style.width = `${imageRect.width}px`;
            canvas.style.height = `${imageRect.height}px`;
            canvas.width = imageRect.width;
            canvas.height = imageRect.height;

            const displaySize = { width: imageRect.width, height: imageRect.height };
            const resizedDetections = faceapi.resizeResults(detection, displaySize);
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            faceapi.draw.drawFaceLandmarks(canvas, resizedDetections);

            const landmarks = detection.landmarks;
            const jaw = landmarks.getJawOutline();
            const leftEye = landmarks.getLeftEye();
            const rightEye = landmarks.getRightEye();
            const leftBrow = landmarks.getLeftEyeBrow();
            const rightBrow = landmarks.getRightEyeBrow();
            const nose = landmarks.getNose();

            // ì„±ë³„ ì¸ì‹ ê²°ê³¼
            // Face-api.jsì˜ gender ì¸ì‹ì€ í™•ë¥  ê¸°ë°˜ì´ë©°, ì‚¬ì§„ ê°ë„ë‚˜ ì„ ëª…ë„ì— ë”°ë¼ ì˜¤ì°¨ê°€ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            // ëª¨ë¸ ìì²´ì˜ í•œê³„ë¡œ ì¸í•´ 100% ì •í™•í•œ ì¸ì‹ì€ ì–´ë µìŠµë‹ˆë‹¤.
            const gender = detection.gender; // 'male' ë˜ëŠ” 'female'
            const genderText = (gender === 'male') ? 'ë‚¨ì„±' : 'ì—¬ì„±';


            // ì–¼êµ´ ë¹„ìœ¨ (ê°€ë¡œ/ì„¸ë¡œ)
            const faceHeight = jaw[8].y - (jaw[0].y + jaw[16].y) / 2;
            const faceWidth = jaw[16].x - jaw[0].x;
            const aspectRatio = faceHeight / faceWidth;

            // --- ì´ë§ˆ ë„“ì´ ê°œì„  ---
            // ì´ë§ˆëŠ” ì–¼êµ´ ëœë“œë§ˆí¬ë§Œìœ¼ë¡œ ì •í™•í•œ í—¤ì–´ë¼ì¸ì„ ì•Œ ìˆ˜ ì—†ì–´ ì¶”ì •ì´ í•„ìš”í•©ë‹ˆë‹¤.
            // ëˆˆì¹ ì¤‘ì•™ì  Yì™€ ì½” ìƒë‹¨(ë¯¸ê°„) Yë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì´ë§ˆ ë†’ì´ë¥¼ ì¶”ì •í•©ë‹ˆë‹¤.
            // ì´ë§ˆ ë†’ì´ / ì–¼êµ´ ì „ì²´ ë†’ì´ ë¹„ìœ¨ë¡œ ë„“ì´ë¥¼ íŒë‹¨í•©ë‹ˆë‹¤.
            const browAverageY = (leftBrow[2].y + rightBrow[2].y) / 2; // ëˆˆì¹ ì¤‘ì•™ Yê°’
            const noseTopY = nose[0].y; // ì½§ëŒ€ ì‹œì‘ (ë¯¸ê°„) Y
            // í—¤ì–´ë¼ì¸ì„ ì§ì ‘ ê°ì§€í•  ìˆ˜ ì—†ìœ¼ë¯€ë¡œ, ë¯¸ê°„ê³¼ ëˆˆì¹ ì‚¬ì´ ë†’ì´ë¥¼ ê¸°ì¤€ìœ¼ë¡œ
            // ëŒ€ëµì ì¸ ì´ë§ˆ ìƒë‹¨ Yë¥¼ ì¶”ì •í•©ë‹ˆë‹¤. (ê²½í—˜ì  ê³„ìˆ˜ ì¡°ì •)
            // ì´ ê³„ìˆ˜(ì˜ˆ: 1.5)ë¥¼ ì¡°ì ˆí•˜ì—¬ ì´ë§ˆ ë„“ì´ íŒë‹¨ì„ ë³€ê²½í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            // ê³„ìˆ˜ê°€ ë†’ìœ¼ë©´ ì´ë§ˆê°€ ë” ë„“ê²Œ, ë‚®ìœ¼ë©´ ë” ì¢ê²Œ ì¸ì‹ë  ê°€ëŠ¥ì„±ì´ ë†’ì•„ì§‘ë‹ˆë‹¤.
            const estimatedTopFaceY = noseTopY - (noseTopY - browAverageY) * 1.5;
            const foreheadHeight = browAverageY - estimatedTopFaceY; // ì¶”ì •ëœ ì´ë§ˆ ë†’ì´

            let foreheadText = 'í‰ê· ì ì¸';
            if (foreheadHeight > 0 && faceHeight > 0) { // ìœ íš¨í•œ ê°’ì¼ ê²½ìš°ì—ë§Œ íŒë‹¨
                 const foreheadToFaceRatio = foreheadHeight / faceHeight; // ì´ë§ˆ ë†’ì´ / ì–¼êµ´ ì „ì²´ ë†’ì´
                // ì•„ë˜ ì„ê³„ê°’ì„ ì¡°ì ˆí•˜ì—¬ 'ì¢ì€ ì´ë§ˆ'ì™€ 'ë„“ì€ ì´ë§ˆ'ì˜ ê¸°ì¤€ì„ ë³€ê²½í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                // ì²« ë²ˆì§¸ ì„ê³„ê°’(0.20): ì´ ê°’ë³´ë‹¤ ì‘ìœ¼ë©´ 'ì¢ì€ ì´ë§ˆ'ë¡œ íŒë‹¨ (ì‘ì„ìˆ˜ë¡ ì¢ë‹¤ê³  íŒë‹¨í•˜ê¸° ì‰¬ì›€)
                // ë‘ ë²ˆì§¸ ì„ê³„ê°’(0.28): ì´ ê°’ë³´ë‹¤ í¬ë©´ 'ë„“ì€ ì´ë§ˆ'ë¡œ íŒë‹¨ (í´ìˆ˜ë¡ ë„“ë‹¤ê³  íŒë‹¨í•˜ê¸° ì‰¬ì›€)
                if (foreheadToFaceRatio < 0.22) { // 0.20 -> 0.22ë¡œ ì¡°ì • (ì¢ì€ ì´ë§ˆ ê¸°ì¤€ì„ ì¡°ê¸ˆ ë” ë†’ì—¬, ë„“ì§€ ì•Šì€ ì´ë§ˆê°€ ë„“ë‹¤ê³  ë‚˜ì˜¤ëŠ” ê²ƒì„ ì¤„ì„)
                    foreheadText = 'ì¢ì€';
                } else if (foreheadToFaceRatio > 0.32) { // 0.28 -> 0.32ë¡œ ì¡°ì • (ë„“ì€ ì´ë§ˆ ê¸°ì¤€ì„ ì¡°ê¸ˆ ë” ë†’ì—¬, ë„“ì§€ ì•Šì€ ì´ë§ˆê°€ ë„“ë‹¤ê³  ë‚˜ì˜¤ëŠ” ê²ƒì„ ì¤„ì„)
                    foreheadText = 'ë„“ì€';
                }
            }


            // --- í„± ëª¨ì–‘ (ê°ë„) ê°œì„  ---
            // í„±ì„  ê°ë„ ê³„ì‚° ë¡œì§ì€ ë™ì¼í•˜ì§€ë§Œ, íŒë‹¨ ì„ê³„ê°’ì„ ë” ì„¸ë°€í•˜ê²Œ ì¡°ì •í•©ë‹ˆë‹¤.
            const p1 = jaw[2], p2 = jaw[4], p3 = jaw[8];
            const v1 = { x: p1.x - p2.x, y: p1.y - p2.y };
            const v2 = { x: p3.x - p2.x, y: p3.y - p2.y };
            const dotProduct = v1.x * v2.x + v1.y * v2.y;
            const magnitude1 = Math.sqrt(v1.x**2 + v1.y**2), magnitude2 = Math.sqrt(v2.x**2 + v2.y**2);
            let jawAngle = 180; // ê¸°ë³¸ê°’
            if (magnitude1 > 0 && magnitude2 > 0) {
                jawAngle = Math.acos(dotProduct / (magnitude1 * magnitude2)) * (180 / Math.PI);
            }
            
            let jawText;
            // ì„±ë³„ì— ë”°ë¼ í„± ê°ë„ ì„ê³„ê°’ ì¡°ì • (ë‚¨ì„±ì´ ì—¬ì„±ë³´ë‹¤ ì¼ë°˜ì ìœ¼ë¡œ í„±ì„ ì´ ë” ê°ì§)
            // 'ê°ì§„' í„± íŒë‹¨ ì„ê³„ê°’: ì´ ê°’ë³´ë‹¤ ì‘ìœ¼ë©´ 'ê°ì§„' í„±ìœ¼ë¡œ íŒë‹¨. (ì‘ì„ìˆ˜ë¡ ê°ì§„ í„±ìœ¼ë¡œ íŒë‹¨í•˜ê¸° ì‰¬ì›€)
            // 'ë‘¥ê·¼' í„± íŒë‹¨ ì„ê³„ê°’: ì´ ê°’ë³´ë‹¤ í¬ë©´ 'ë‘¥ê·¼' í„±ìœ¼ë¡œ íŒë‹¨. (í´ìˆ˜ë¡ ë‘¥ê·¼ í„±ìœ¼ë¡œ íŒë‹¨í•˜ê¸° ì‰¬ì›€)
            // ë‚¨ì„± ê¸°ì¤€: ë” ë‚®ì€ ê°ë„(ì˜ˆ: 135ë„)ë¶€í„° ê°ì§„ ê²ƒìœ¼ë¡œ, ë” ë†’ì€ ê°ë„(ì˜ˆ: 150ë„)ë¶€í„° ë‘¥ê·¼ ê²ƒìœ¼ë¡œ
            // ì—¬ì„± ê¸°ì¤€: ë‚¨ì„±ë³´ë‹¤ ê°ë„ ë²”ìœ„ê°€ ì¢ìŒ (ëœ ê°ì§€ê³  ë” ë‘¥ê·¼ ê²½í–¥)
            const angleThresholdHard = (gender === 'male') ? 135 : 140; // ì´ì „ê³¼ ë™ì¼
            const angleThresholdSoft = (gender === 'male') ? 150 : 155; // ì´ì „ê³¼ ë™ì¼

            if (jawAngle < angleThresholdHard) {
                jawText = 'ê°ì§€ê³  ëšœë ·í•œ';
            } else if (jawAngle > angleThresholdSoft) {
                jawText = 'ë‘¥ê¸€ê³  ë¶€ë“œëŸ¬ìš´';
            } else {
                jawText = 'í‰ê· ì ì¸';
            }

            // --- ëˆˆ ëª¨ì–‘ (ê°€ë¡œ ê¸¸ì´) ê°œì„  ---
            // ëˆˆ ê°€ë¡œ ê¸¸ì´ / ëˆˆ ì„¸ë¡œ ë†’ì´ ë¹„ìœ¨ë¡œ íŒë‹¨í•©ë‹ˆë‹¤.
            // ì´ ë¹„ìœ¨ì´ ë†’ìœ¼ë©´ ê°€ë¡œë¡œ ê¸´ ëˆˆ, ë‚®ìœ¼ë©´ ë‘¥ê·¼ ëˆˆì…ë‹ˆë‹¤.
            const leftEyeWidth = leftEye[3].x - leftEye[0].x; // ì™¼ìª½ ëˆˆ ê°€ë¡œ ê¸¸ì´
            const leftEyeHeight = (leftEye[4].y + leftEye[5].y) / 2 - (leftEye[1].y + leftEye[2].y) / 2; // ì™¼ìª½ ëˆˆ ì„¸ë¡œ ë†’ì´ (ëˆˆêº¼í’€ ê¸°ì¤€)
            let eyeShapeRatio = 0;
            if (leftEyeHeight > 0) {
                 eyeShapeRatio = leftEyeWidth / leftEyeHeight;
            }
            
            let eyeShapeText;
            // ì´ ì„ê³„ê°’ì„ ì¡°ì ˆí•˜ì—¬ 'ë‘¥ê·¼ ëˆˆ'ê³¼ 'ê¸´ ëˆˆ'ì˜ ê¸°ì¤€ì„ ë³€ê²½í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            // ì²« ë²ˆì§¸ ì„ê³„ê°’(2.8): ì´ ê°’ë³´ë‹¤ ì‘ìœ¼ë©´ 'ë‘¥ê·¼ ëˆˆ'ìœ¼ë¡œ íŒë‹¨. (í´ìˆ˜ë¡ ë‘¥ê·¼ ëˆˆìœ¼ë¡œ íŒë‹¨í•˜ê¸° ì‰¬ì›€)
            // ë‘ ë²ˆì§¸ ì„ê³„ê°’(3.5): ì´ ê°’ë³´ë‹¤ í¬ë©´ 'ê¸´ ëˆˆ'ìœ¼ë¡œ íŒë‹¨. (ì‘ì„ìˆ˜ë¡ ê¸´ ëˆˆìœ¼ë¡œ íŒë‹¨í•˜ê¸° ì‰¬ì›€)
            if (eyeShapeRatio < 2.9) { // 2.8 -> 2.9 (ì´ì „ë³´ë‹¤ ì¡°ê¸ˆ ë” ê¸¸ì–´ì•¼ 'ê¸´ ëˆˆ'ìœ¼ë¡œ íŒë‹¨ë˜ë„ë¡ ê¸°ì¤€ ê°•í™”)
                eyeShapeText = 'ë‘¥ê·¼';
            } else if (eyeShapeRatio > 3.6) { // 3.5 -> 3.6 (ì´ì „ë³´ë‹¤ ë” ê¸¸ì–´ì•¼ 'ê¸´ ëˆˆ'ìœ¼ë¡œ íŒë‹¨ë˜ë„ë¡ ê¸°ì¤€ ê°•í™”)
                eyeShapeText = 'ê°€ë¡œë¡œ ê¸´';
            } else {
                eyeShapeText = 'í‰ê· ì ì¸';
            }
            

            // ëˆˆê³¼ ëˆˆì¹ ì‚¬ì´ ê±°ë¦¬ (step1)
            const leftEyeCenterY = (leftEye[1].y + leftEye[2].y + leftEye[4].y + leftEye[5].y) / 4;
            const leftEyebrowY = (landmarks.getLeftEyeBrow()[0].y + landmarks.getLeftEyeBrow()[1].y + landmarks.getLeftEyeBrow()[2].y + landmarks.getLeftEyeBrow()[3].y + landmarks.getLeftEyeBrow()[4].y) / 5;
            const eyeToEyebrowDistance = leftEyeCenterY - leftEyebrowY;
            // ëˆˆ ë†’ì´ ëŒ€ë¹„ ëˆˆì¹ ê±°ë¦¬ ë¹„ìœ¨
            const normalizedDistance = eyeToEyebrowDistance / leftEyeHeight;
            // ì´ ì„ê³„ê°’(0.7)ì„ ì¡°ì ˆí•˜ì—¬ 'ëˆˆê³¼ ëˆˆì¹ ì‚¬ì´ê°€ ë©€ë‹¤'ì™€ 'ì¢ë‹¤'ì˜ ê¸°ì¤€ì„ ë³€ê²½í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            // ê°’ì´ ì‘ì„ìˆ˜ë¡ 'ë©€ë‹¤(A)'ë¡œ íŒë‹¨í•˜ê¸° ì‰¬ì›Œì§‘ë‹ˆë‹¤.
            const step1_result = (normalizedDistance > 0.7) ? 'A' : 'B';


            // ì´ëª©êµ¬ë¹„ ì§‘ì¤‘ë„ (step4) - ë¯¸ê°„ ê°„ê²©
            const interEyeDistance = rightEye[0].x - leftEye[3].x; // ì–‘ìª½ ëˆˆ ì•ˆìª½ ë ì‚¬ì´ ê±°ë¦¬
            const oneEyeWidth = leftEye[3].x - leftEye[0].x; // í•œìª½ ëˆˆì˜ ê°€ë¡œ ê¸¸ì´
            // ë¯¸ê°„ ê°„ê²© / í•œìª½ ëˆˆì˜ ë„ˆë¹„ ë¹„ìœ¨
            const eyeSpacingRatio = interEyeDistance / oneEyeWidth;

            let eyeSpacingTextDetailed;
            // ì´ ì„ê³„ê°’ì„ ì¡°ì ˆí•˜ì—¬ 'ì¢ì€ ë¯¸ê°„'ê³¼ 'ë„“ì€ ë¯¸ê°„'ì˜ ê¸°ì¤€ì„ ë³€ê²½í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            // 0.9ë³´ë‹¤ ì‘ìœ¼ë©´ 'ì¢ì€', 1.1ë³´ë‹¤ í¬ë©´ 'ë„“ì€'
            if (eyeSpacingRatio < 0.9) {
                eyeSpacingTextDetailed = 'ì¢ì€';
            } else if (eyeSpacingRatio > 1.1) {
                eyeSpacingTextDetailed = 'ë„“ì€';
            } else {
                eyeSpacingTextDetailed = 'í‰ê· ì ì¸';
            }
            const step4_result = (eyeSpacingRatio < 0.9) ? 'A' : 'B'; // ì´ëª©êµ¬ë¹„ ì§‘ì¤‘ë„ (A:ì¤‘ì•™ì— ëª¨ì„, B:ë„“ê²Œ í¼ì§)


            // ì–¼êµ´ ê°€ë¡œ/ì„¸ë¡œ ë¹„ìœ¨ (step5) - aspectRatio ì¬í™œìš©
            // ì´ ì„ê³„ê°’(1.25)ì„ ì¡°ì ˆí•˜ì—¬ 'ë™ê·¸ë€ ì–¼êµ´í˜•'ê³¼ 'ê¸´ ì–¼êµ´í˜•'ì˜ ê¸°ì¤€ì„ ë³€ê²½í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            // ê°’ì´ ì‘ì„ìˆ˜ë¡ 'ë™ê·¸ë€ ì–¼êµ´í˜•(C)'ìœ¼ë¡œ íŒë‹¨í•˜ê¸° ì‰¬ì›Œì§‘ë‹ˆë‹¤.
            const step5_result = (aspectRatio < 1.25) ? 'C' : 'D';


            // ë¯¸ê°„ ë„ˆë¹„ì™€ ì¸ìƒ (step6) - ë³µí•©ì  íŒë‹¨
            // step4 (ì´ëª©êµ¬ë¹„ ì§‘ì¤‘ë„)ì™€ step2 (ì–¼êµ´ì„ ) ê²°ê³¼ë¥¼ í™œìš©í•˜ì—¬ íŒë‹¨í•©ë‹ˆë‹¤.
            let step6_result;
            // 'E' (ë¯¸ê°„ ì¢ê³  ë¶€ë“œëŸ¬ìš´ ì¸ìƒ)ìœ¼ë¡œ íŒë‹¨ë˜ëŠ” ì¡°ê±´:
            // ì´ëª©êµ¬ë¹„ê°€ ì¤‘ì•™ì— ëª¨ì—¬ìˆê³  (step4 'A'), ì–¼êµ´ì„ ì´ ë‘¥ê¸€ ë•Œ (step2 'C').
            // ì´ ì¡°ê±´ì„ ê°•í™”/ì™„í™”í•˜ë ¤ë©´ step4_resultì™€ step2_resultì˜ íŒë‹¨ ì„ê³„ê°’ì„ ì¡°ì ˆí•´ì•¼ í•©ë‹ˆë‹¤.
            if (step4_result === 'A' && step2_result === 'C') { 
                step6_result = 'E';
            } else {
                step6_result = 'F';
            }


            const analysisResult = { 
                step1: step1_result, 
                step2: step2_result, 
                step3: (eyeShapeRatio < 2.9) ? 'E' : 'F', // ì§ì ‘ eyeShapeRatioë¡œ íŒë‹¨
                step4: step4_result, 
                step5: step5_result, 
                step6: step6_result,
                gender: genderText,
                forehead: foreheadText,
                jaw: jawText,
                eyeShape: eyeShapeText, // ìƒˆë¡œ ì¶”ê°€ëœ ëˆˆ ëª¨ì–‘ ë¶„ì„ í…ìŠ¤íŠ¸
                eyeSpacing: eyeSpacingTextDetailed // ìƒì„¸ ë¯¸ê°„ ê°„ê²© í…ìŠ¤íŠ¸
            };
            
            displayResults(analysisResult, true);
            showPage('result-page');

        } catch (error) {
            console.error("ì‚¬ì§„ ë¶„ì„ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
            alert("ì‚¬ì§„ì„ ë¶„ì„í•˜ëŠ” ì¤‘ì— ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì–¼êµ´ì´ ì˜ ë‚˜ì˜¨ ë‹¤ë¥¸ ì‚¬ì§„ìœ¼ë¡œ ì‹œë„í•´ë³´ê±°ë‚˜, ì„¤ë¬¸ìœ¼ë¡œ ì§„ë‹¨í•˜ëŠ” ë°©ë²•ì„ ì´ìš©í•´ì£¼ì„¸ìš”. (ì„¸ë¶€ ì˜¤ë¥˜: " + error.message + ")");
        } finally {
            if(loader) loader.style.display = 'none';
            if(analyzeBtn) analyzeBtn.style.display = 'block';
        }
    }

    function analyzeQuiz() {
        const form = document.getElementById('quiz-form');
        const analysisResult = {
            step1: form.elements['q1'].value,
            step2: form.elements['q2'].value,
            step3: form.elements['q3'].value,
            step4: form.elements['q4'].value,
            step5: form.elements['q5'].value,
            step6: form.elements['q6'].value,
        };
        if (Object.values(analysisResult).some(v => !v)) {
            alert("ëª¨ë“  ì§ˆë¬¸ì— ë‹µë³€í•´ì£¼ì„¸ìš”!");
            return;
        }
        displayResults(analysisResult, false);
        showPage('result-page');
    }

    function displayResults(analysis, fromPhoto = false) {
        const content = document.getElementById('result-content');
        if (!content) return;

        // 1. ìµœì¢… ìœ í˜•(Type) ê²°ì • ë¡œì§
        let finalType;
        if (analysis.step2 === 'D' && analysis.step1 === 'A') finalType = 'A';
        else if (analysis.step2 === 'D' && analysis.step1 === 'B') finalType = 'B';
        else if (analysis.step2 === 'C' && analysis.step1 === 'A') finalType = 'C';
        else finalType = 'D';

        // 2. ê° íƒ€ì…ë³„ ì •ë³´ (íƒ€ì´í‹€, ì„¤ëª…, ì˜ˆì‹œ ì—°ì˜ˆì¸, ì´ë¯¸ì§€ ê²½ë¡œ)
        const typeInfo = {
            'A': {
                title: "Type A : ì„¸ë ¨ëœ íŒŒì›Œ ì…€ëŸ½í˜•",
                description: "ë˜ë ·í•œ ì¸ìƒì„ ì£¼ëŠ” ê°ì§„ ëª¨ì–‘ê³¼ í’ì„±í•˜ê³  ë„í†°í•œ ëˆˆì¹ì˜ ì¡°í•©ì…ë‹ˆë‹¤. ìì‹ ê° ìˆê³  ì¹´ë¦¬ìŠ¤ë§ˆ ë„˜ì¹˜ëŠ” ì´ë¯¸ì§€ë¥¼ ì—°ì¶œí•˜ê¸°ì— ì¢‹ìŠµë‹ˆë‹¤. ëˆˆì¹ì˜ ì „ì²´ì ì¸ ê¸¸ì´ëŠ” ì•„ë˜ ìƒì„¸ ê°€ì´ë“œì—ì„œ ë‹¹ì‹ ì˜ ì–¼êµ´ ë¹„ìœ¨ì— ë§ê²Œ ì¡°ì ˆí•˜ì—¬, ì „ì²´ì ì¸ ì¸ìƒì˜ ì™„ì„±ë„ë¥¼ ë†’ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.",
                celebrities: ["ê¹€í˜œìˆ˜", "í•œì†Œí¬"],
                image: "https://image.isplus.com/data/isp/image/2025/03/20/isp20250320000163.800x.0.jpg"
            },
            'B': {
                title: "Type B : ì‹œí¬í•œ ë„ì‹œ ëª¨ë¸í˜•",
                description: "ë‚ ì¹´ë¡­ê³  ì„¸ë ¨ëœ ëŠë‚Œì˜ ê°ì§„ ëª¨ì–‘ê³¼ ì–‡ê³  ì •êµí•œ ëˆˆì¹ì˜ ì¡°í•©ì…ë‹ˆë‹¤. ì‹œí¬í•˜ê³  ë„íšŒì ì¸ ë¶„ìœ„ê¸°ë¥¼ ì—°ì¶œí•˜ëŠ” ë° íš¨ê³¼ì ì…ë‹ˆë‹¤. ëˆˆì¹ì˜ ì „ì²´ì ì¸ ê¸¸ì´ëŠ” ì•„ë˜ ìƒì„¸ ê°€ì´ë“œì—ì„œ ë‹¹ì‹ ì˜ ì–¼êµ´ ë¹„ìœ¨ì— ë§ê²Œ ì¡°ì ˆí•˜ì—¬, ì „ì²´ì ì¸ ì¸ìƒì˜ ì™„ì„±ë„ë¥¼ ë†’ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.",
                celebrities: ["ê¹€ì„œí˜•", "ì•„ì´ìœ "],
                image: "https://www.elle.co.kr/resources_old/online/org_online_image/el/a15eacb9-d825-4655-9264-24e5b93b58c9.jpg"
            },
            'C': {
                title: "Type C : ë¶€ë“œëŸ¬ìš´ ì²«ì‚¬ë‘í˜•",
                description: "ì„ í•˜ê³  ë¶€ë“œëŸ¬ìš´ ì¸ìƒì„ ì£¼ëŠ” ë‘¥ê·¼ ëª¨ì–‘ê³¼ ìì—°ìŠ¤ëŸ½ê³  ë„í†°í•œ ëˆˆì¹ì˜ ì¡°í•©ì…ë‹ˆë‹¤. ì²­ìˆœí•˜ê³  ì–´ë ¤ ë³´ì´ëŠ” ì´ë¯¸ì§€ë¥¼ ë§Œë“œëŠ” ë° ê°€ì¥ ì´ìƒì ì…ë‹ˆë‹¤. ëˆˆì¹ì˜ ì „ì²´ì ì¸ ê¸¸ì´ëŠ” ì•„ë˜ ìƒì„¸ ê°€ì´ë“œì—ì„œ ë‹¹ì‹ ì˜ ì–¼êµ´ ë¹„ìœ¨ì— ë§ê²Œ ì¡°ì ˆí•˜ì—¬, ì „ì²´ì ì¸ ì¸ìƒì˜ ì™„ì„±ë„ë¥¼ ë†’ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.",
                celebrities: ["ì œë‹ˆ(ë¸”ë™í•‘í¬)", "ì„ìœ¤ì•„"],
                image: "https://t1.daumcdn.net/news/202504/18/inews24/20250418141440222zwyv.jpg"
            },
            'D': {
                title: "Type D : ë‹¨ì•„í•œ í´ë˜ì‹í˜•",
                description: "ë¶€ë“œëŸ¬ìš´ ê³¡ì„  ëª¨ì–‘ê³¼ ê¹”ë”í•˜ê³  ì–‡ì€ ëˆˆì¹ì˜ ì¡°í•©ì…ë‹ˆë‹¤. ë‹¨ì•„í•˜ê³  í´ë˜ì‹í•œ ë¶„ìœ„ê¸°ë¥¼ ì—°ì¶œí•˜ë©°, ê°€ì¥ ì‹¤íŒ¨ í™•ë¥ ì´ ì ì€ ìŠ¤íƒ€ì¼ì…ë‹ˆë‹¤. ëˆˆì¹ì˜ ì „ì²´ì ì¸ ê¸¸ì´ëŠ” ì•„ë˜ ìƒì„¸ ê°€ì´ë“œì—ì„œ ë‹¹ì‹ ì˜ ì–¼êµ´ ë¹„ìœ¨ì— ë§ê²Œ ì¡°ì ˆí•˜ì—¬, ì „ì²´ì ì¸ ì¸ìƒì˜ ì™„ì„±ë„ë¥¼ ë†’ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.",
                celebrities: ["ê¹€ê³ ì€", "ì†¡í˜œêµ"],
                image: "https://img-s-msn-com.akamaized.net/tenant/amp/entityid/AA1HC3K5.img?w=650&h=865&m=6&x=172&y=224&s=289&d=289"
            }
        };

        const currentType = typeInfo[finalType];
        
        // ìƒì„¸ ê°€ì´ë“œ í…ìŠ¤íŠ¸
        const detailTexts = {
            shape: analysis.step2 === 'D' ? 'ì‚°ê³¼ ê°ì„ ì‚´ë¦°' : 'ë¶€ë“œëŸ¬ìš´ ê³¡ì„ ',
            thickness: analysis.step1 === 'A' ? 'ë„í†°í•œ' : 'ì–‡ì€',
            length: analysis.step5 === 'C' ? 'ì¡°ê¸ˆ ê¸¸ê²Œ ê·¸ë ¤' : 'ì¡°ê¸ˆ ì§§ê²Œ ê·¸ë ¤',
            detail: `ëˆˆì¹ ${analysis.step4 === 'A' ? 'ì‚°ì„ ê¸¸ê²Œ, ê¼¬ë¦¬ë¥¼ ì§§ê²Œ' : 'ì‚°ì„ ì§§ê²Œ, ê¼¬ë¦¬ë¥¼ ê¸¸ê²Œ'}, ${analysis.step6 === 'E' ? 'ì•ë¨¸ë¦¬ëŠ” ì˜…ê²Œ í‘œí˜„' : 'ì•ë¨¸ë¦¬ ê²°ì„ ì‚´ë ¤ í‘œí˜„'}`
        };

        let analysisDetailsHTML = '';
        if (fromPhoto) {
            analysisDetailsHTML = `
                <h4>ì‚¬ì§„ ë¶„ì„ ê²°ê³¼</h4>
                <ul style="list-style-type: disc; margin-left: 20px;">
                    <li>ì˜ˆìƒ ì„±ë³„: <strong>${analysis.gender}</strong></li>
                    <li>ì´ë§ˆ: <strong>${analysis.forehead}</strong> í¸ì…ë‹ˆë‹¤.</li>
                    <li>í„±: <strong>${analysis.jaw}</strong> í¸ì…ë‹ˆë‹¤.</li>
                    <li>ëˆˆ ëª¨ì–‘: <strong>${analysis.eyeShape}</strong> í¸ì…ë‹ˆë‹¤.</li>
                    <li>ë¯¸ê°„ ê°„ê²©: <strong>${analysis.eyeSpacing}</strong> í¸ì…ë‹ˆë‹¤.</li>
                    <li>ì–¼êµ´ ë¹„ìœ¨: ê°€ë¡œ/ì„¸ë¡œ ë¹„ìœ¨ì€ <strong>${analysis.step5 === 'C' ? 'ë™ê·¸ë€ ì–¼êµ´í˜•ì— ê°€ê¹ê³ ' : 'íƒ€ì›í˜•/ê¸´ ì–¼êµ´í˜•ì— ê°€ê¹ìŠµë‹ˆë‹¤'}</strong>.</li>
                    <li>ëˆˆê³¼ ëˆˆì¹ ì‚¬ì´: <strong>${analysis.step1 === 'A' ? 'ëˆˆê³¼ ëˆˆì¹ ì‚¬ì´ê°€ ë©€ê³ ' : 'ëˆˆê³¼ ëˆˆì¹ ì‚¬ì´ê°€ ì¢ìŠµë‹ˆë‹¤'}</strong>.</li>
                </ul>
                <p class="photo-basis">â€» ìœ„ ê²°ê³¼ëŠ” AI ë¶„ì„ì— ê¸°ë°˜í•œ ê²ƒìœ¼ë¡œ, ì‹¤ì œì™€ ë‹¤ë¥¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                <hr style="border-top: 1px dashed #ccc; margin: 20px 0;">
            `;
        }

        const resultHTML = `
            <div class="result-card">
                <h3>${currentType.title}</h3>
                <p style="font-weight: 500;">${currentType.description}</p>
                ${analysisDetailsHTML}
                <div style="margin: 20px 0;">
                    <img src="${currentType.image}" alt="${currentType.title}" style="width: 100%; border-radius: 8px;">
                    <p style="font-size: 0.9em; color: #555; margin-top: 10px;">(ì˜ˆì‹œ: ${currentType.celebrities.join(', ')} ìŠ¤íƒ€ì¼)</p>
                </div>

                <h4>ë‹¹ì‹ ì„ ìœ„í•œ ìƒì„¸ ê°€ì´ë“œ</h4>
                <ul>
                    <li><strong>ëª¨ì–‘:</strong> ${detailTexts.shape} ëˆˆì¹</li>
                    <li><strong>ë‘ê»˜:</strong> ${detailTexts.thickness} ëˆˆì¹</li>
                    <li><strong>ê¸¸ì´:</strong> ${detailTexts.length} ì–¼êµ´ ë¹„ìœ¨ ë³´ì™„</li>
                    <li><strong>ë””í…Œì¼:</strong> ${detailTexts.detail}</li>
                </ul>
            </div>
        `;

        content.innerHTML = resultHTML;
    }
</script>
</body>
</html>
