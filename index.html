<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>眉완성: 내 인생 눈썹 찾기</title>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <style>
        :root {
            --primary-color: #6a5acd; /* SlateBlue */
            --secondary-color: #f0e6ff;
            --text-color: #333;
            --bg-color: #f8f9fa;
            --container-bg: #ffffff;
            --border-radius: 16px;
            --shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            box-sizing: border-box;
            color: var(--text-color);
        }
        .main-container {
            width: 100%;
            max-width: 500px;
            background-color: var(--container-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 25px;
            box-sizing: border-box;
            text-align: center;
        }
        h1, h2, h3 {
            margin: 0 0 15px;
            color: var(--primary-color);
        }
        h1 { font-size: 2rem; }
        h2 { font-size: 1.6rem; }
        p { line-height: 1.7; margin: 0 0 20px; }
        .btn {
            display: block;
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            border: none;
            border-radius: 12px;
            background-color: var(--primary-color);
            color: white;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
        }
        .btn:hover { background-color: #5a4ab9; }
        .btn:active { transform: scale(0.98); }
        .btn.secondary {
            background-color: #e9ecef;
            color: var(--text-color);
        }
        .btn.secondary:hover { background-color: #d3d9df; }
        .page { display: none; }
        .page.active { display: block; }
        #guide-container {
            width: 100%;
            aspect-ratio: 3 / 4;
            background-color: #e9ecef;
            border: 2px dashed #ced4da;
            border-radius: 12px;
            position: relative;
            overflow: hidden;
            user-select: none;
            margin: 20px 0;
        }
        #user-image, #overlay-canvas {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            max-width: 100%;
            max-height: 100%;
            height: auto;
            width: 80%; /* Initial size */
        }
        #user-image { cursor: grab; }
        #user-image:active { cursor: grabbing; }
        #overlay-canvas { pointer-events: none; }
        .sliders {
            margin-top: 20px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 8px;
        }
        .slider-group {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }
        .slider-group label { font-size: 14px; width: 80px; text-align: left;}
        input[type="range"] { flex-grow: 1; }
        .question { margin-bottom: 30px; text-align: left; }
        .question p { font-weight: 500; margin-bottom: 15px; }
        .options { display: flex; flex-direction: column; gap: 10px; }
        .result-card {
            background-color: var(--secondary-color);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            text-align: left;
        }
        .result-card h3 { color: var(--primary-color); border-bottom: 2px solid var(--primary-color); padding-bottom: 10px; margin-bottom: 15px;}
        .result-card ul { padding-left: 20px; margin: 0; }
        .result-card li { margin-bottom: 10px; }
        .result-card .photo-basis {
            font-size: 0.85em;
            color: #555;
            padding-left: 8px;
        }
        #loader {
            border: 8px solid #f3f3f3;
            border-radius: 50%;
            border-top: 8px solid var(--primary-color);
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin: 30px auto;
            display: none;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>

    <div class="main-container">

        <div id="start-page" class="page active">
            <h1>眉완성</h1>
            <p><strong>내 얼굴에 딱 맞는 인생 눈썹을 찾아보세요!</strong><br>두 가지 방법 중 하나를 선택해 진단을 시작할 수 있습니다.</p>
            <button class="btn" onclick="showPage('photo-page')">📸 사진으로 분석하기</button>
            <button class="btn" onclick="showPage('quiz-page')">✍️ 설문으로 진단하기</button>
            <p style="font-size: 0.8em; color: #888; margin-top: 20px;">
                사진은 서버에 저장되지 않으며, 분석은 모두 사용자의 기기에서만 이루어집니다.
            </p>
        </div>

        <div id="photo-page" class="page">
            <h2>사진으로 분석하기</h2>
            <p>정면을 바라보는 선명한 사진을 올리고<br>가이드라인에 맞춰 얼굴을 조정해주세요.</p>
            
            <label for="file-input" class="btn secondary">🖼️ 사진 선택</label>
            <input type="file" id="file-input" accept="image/*" style="display:none;">

            <div id="guide-container">
                <img id="user-image" src="" alt="User's face" style="display:none;">
                <canvas id="overlay-canvas"></canvas>
            </div>

            <div id="sliders-container" class="sliders" style="display:none;">
                <div class="slider-group">
                    <label for="size-slider">사진 크기</label>
                    <input type="range" id="size-slider" min="10" max="250" value="80">
                </div>
                <div class="slider-group">
                    <label for="opacity-slider">투명도</label>
                    <input type="range" id="opacity-slider" min="0" max="1" step="0.05" value="0.7">
                </div>
            </div>
            
            <div id="loader"></div>
            <button class="btn" id="analyze-btn" onclick="analyzePhoto()" style="display:none;">결과 분석하기</button>
            <button class="btn secondary" onclick="showPage('start-page')">뒤로 가기</button>
        </div>

<div id="quiz-page" class="page">
    <h2>설문으로 진단하기</h2>
    <p>아래 질문에 답하여<br>자신에게 꼭 맞는 눈썹 스타일을 찾아보세요.</p>
    
    <form id="quiz-form">
        <div class="question">
            <p>1. 내 얼굴의 특징은 어디에 가깝나요?</p>
            <div class="options">
                <label><input type="radio" name="q1" value="A"> 얼굴이 길거나, 눈과 눈썹 사이가 멀다.</label>
                <label><input type="radio" name="q1" value="B"> 얼굴이 짧거나, 눈과 눈썹 사이가 좁다.</label>
            </div>
        </div>
        <div class="question">
            <p>2. 나의 전체적인 인상이나 얼굴 라인은?</p>
            <div class="options">
                <label><input type="radio" name="q2" value="C"> 얼굴선이 둥글고, 청순하고 부드러운 인상이다.</label>
                <label><input type="radio" name="q2" value="D"> 얼굴선이 각지고, 세련되고 또렷한 인상이다.</label>
            </div>
        </div>
        <div class="question">
            <p>3. 내 눈 모양은 어떤가요?</p>
            <div class="options">
                <label><input type="radio" name="q3" value="E"> 눈이 전체적으로 동그란 편이다.</label>
                <label><input type="radio" name="q3" value="F"> 눈이 가로로 긴 편이다.</label>
            </div>
        </div>
        <div class="question">
            <p>4. 내 이목구비는 얼굴 중앙에 모여있는 편인가요?</p>
            <div class="options">
                <label><input type="radio" name="q4" value="A"> 이목구비가 중앙에 모여있고, 눈 사이가 가깝다 (내심안).</label>
                <label><input type="radio" name="q4" value="B"> 이목구비가 넓게 퍼져있고, 눈 사이가 멀다 (외심안).</label>
            </div>
        </div>
        <div class="question">
            <p>5. 내 얼굴의 가로/세로 비율은 어떤가요?</p>
            <div class="options">
                <label><input type="radio" name="q5" value="C"> 가로 대비 세로 길이가 짧은 동그란 얼굴형이다.</label>
                <label><input type="radio" name="q5" value="D"> 가로 대비 세로 길이가 긴 타원형/긴 얼굴형이다.</label>
            </div>
        </div>
        <div class="question">
            <p>6. 나의 미간 너비와 추구하는 인상은?</p>
            <div class="options">
                <label><input type="radio" name="q6" value="E"> 미간이 좁은 편이며, 부드러운 인상을 원한다.</label>
                <label><input type="radio" name="q6" value="F"> 미간이 넓은 편이며, 또렷한 인상을 원한다.</label>
            </div>
        </div>
        <button type="button" class="btn" onclick="analyzeQuiz()">결과 확인하기</button>
        <button type="button" class="btn secondary" onclick="showPage('start-page')">뒤로 가기</button>
    </form>
</div>

    <script>
        // 전역 변수 및 설정
        const pages = document.querySelectorAll('.page');
        const loader = document.getElementById('loader');
        const analyzeBtn = document.getElementById('analyze-btn');
        let modelsLoaded = false;

// [개선된] 페이지 전환 함수
function showPage(pageId) {
    pages.forEach(page => page.classList.remove('active'));
    document.getElementById(pageId).classList.add('active');

    const canvas = document.getElementById('overlay-canvas');
    const ctx = canvas.getContext('2d');
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    // [개선 3] '다시하기' 클릭 시, 이전 사진 및 분석 흔적 완벽 제거
    if (pageId === 'start-page') {
        // 파일 입력(input)과 이미지(img) 태그를 모두 초기화
        const fileInput = document.getElementById('file-input');
        const userImage = document.getElementById('user-image');
        const slidersContainer = document.getElementById('sliders-container');
        const analyzeBtn = document.getElementById('analyze-btn');

        fileInput.value = ''; // 파일 선택 상태 초기화
        userImage.src = '';   // 이미지 소스 제거
        userImage.style.display = 'none'; // 이미지 숨기기
        slidersContainer.style.display = 'none'; // 슬라이더 숨기기
        analyzeBtn.style.display = 'none'; // 분석 버튼 숨기기
    }
}

        // [수정] face-api 모델 로드 (SsdMobilenetv1 모델로 변경)
        async function loadModels() {
            const MODEL_URL = './models';
            try {
                console.log("모델 로딩을 시작합니다...");
                await Promise.all([
                    faceapi.nets.ssdMobilenetv1.loadFromUri(MODEL_URL),
                    faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL)
                ]);
                modelsLoaded = true;
                console.log("모델 로딩 완료! 이제 사진 분석을 할 수 있습니다.");
            } catch (error) {
                console.error("모델 로딩 실패:", error);
                alert("분석 모델을 불러오는 데 실패했습니다. 페이지를 새로고침 해주세요.");
            }
        }
        loadModels();

        // --- 사진 분석 관련 스크립트 ---
        const fileInput = document.getElementById('file-input');
        const userImage = document.getElementById('user-image');
        const slidersContainer = document.getElementById('sliders-container');
        const guideContainer = document.getElementById('guide-container');

        fileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;

            // 새로운 사진을 올리면 이전 캔버스 흔적을 지웁니다.
            const canvas = document.getElementById('overlay-canvas');
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            const reader = new FileReader();
            reader.onload = (e) => {
                userImage.src = e.target.result;
                userImage.style.display = 'block';
                userImage.onload = () => {
                    slidersContainer.style.display = 'block';
                    analyzeBtn.style.display = 'block';
                    
                    document.getElementById('size-slider').value = 80;
                    document.getElementById('opacity-slider').value = 0.7;
                    userImage.style.width = '80%';
                    userImage.style.opacity = '0.7';
                    userImage.style.top = '50%';
                    userImage.style.left = '50%';
                };
            };
            reader.readAsDataURL(file);
        });

        // 이미지 드래그 기능
        let isImageDragging = false;
        let startX, startY, initialLeft, initialTop;
        userImage.addEventListener('mousedown', e => {
            if (!userImage.src) return;
            e.preventDefault();
            isImageDragging = true;
            userImage.style.cursor = 'grabbing';
            startX = e.clientX;
            startY = e.clientY;
            initialLeft = userImage.offsetLeft;
            initialTop = userImage.offsetTop;
            window.addEventListener('mousemove', dragImage);
            window.addEventListener('mouseup', stopDragImage);
        });

        function dragImage(e) {
            if (!isImageDragging) return;
            userImage.style.left = `${initialLeft + (e.clientX - startX)}px`;
            userImage.style.top = `${initialTop + (e.clientY - startY)}px`;
        }
        function stopDragImage() {
            isImageDragging = false;
            userImage.style.cursor = 'grab';
            window.removeEventListener('mousemove', dragImage);
            window.removeEventListener('mouseup', stopDragImage);
        }

        // 슬라이더 이벤트 리스너
        document.getElementById('size-slider').addEventListener('input', (e) => {
            userImage.style.width = `${e.target.value}%`;
        });
        document.getElementById('opacity-slider').addEventListener('input', (e) => {
            userImage.style.opacity = e.target.value;
        });
        
async function analyzePhoto() {
    if (!modelsLoaded) {
        alert("분석 모델이 아직 로딩 중입니다. 잠시 후 다시 시도해주세요.");
        return;
    }
    if (!userImage.src || userImage.style.display === 'none') {
        alert("먼저 사진을 선택해주세요.");
        return;
    }

    loader.style.display = 'block';
    analyzeBtn.style.display = 'none';

    try {
        const detection = await faceapi.detectSingleFace(userImage, new faceapi.SsdMobilenetv1Options()).withFaceLandmarks();

        if (!detection) {
            loader.style.display = 'none';
            analyzeBtn.style.display = 'block';
            alert("얼굴을 인식할 수 없습니다. 더 선명하고 정면을 바라보는 사진을 사용해주세요.");
            return;
        }

        const canvas = document.getElementById('overlay-canvas');
        const ctx = canvas.getContext('2d');
        const imageRect = userImage.getBoundingClientRect();
        const containerRect = guideContainer.getBoundingClientRect();
        
        canvas.style.top = `${imageRect.top - containerRect.top}px`;
        canvas.style.left = `${imageRect.left - containerRect.left}px`;
        canvas.style.width = `${imageRect.width}px`;
        canvas.style.height = `${imageRect.height}px`;
        canvas.width = imageRect.width;
        canvas.height = imageRect.height;
        
        const displaySize = { width: imageRect.width, height: imageRect.height };
        const resizedDetections = faceapi.resizeResults(detection, displaySize);
        
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        faceapi.draw.drawFaceLandmarks(canvas, resizedDetections);
        
        const landmarks = detection.landmarks;
        const jaw = landmarks.getJawOutline();
        const leftEye = landmarks.getLeftEye();
        const rightEye = landmarks.getRightEye();

        // --- [전면 수정] 얼굴형(A/B) 분석 로직 ---
        let score = 0;

        // 지표 1: 얼굴 전체의 가로 대비 세로 비율 (긴 얼굴 판단)
        const faceHeight = jaw[8].y - (jaw[0].y + jaw[16].y) / 2;
        const faceWidth = jaw[16].x - jaw[0].x;
        const aspectRatio = faceHeight / faceWidth;
        // [민감도 조절 1] 이 값이 낮을수록 '긴 얼굴'로 판단하기 쉬워집니다. (e.g., 1.25)
        const aspectRatioThreshold = 1.3; 
        if (aspectRatio > aspectRatioThreshold) {
            score++;
        }

        // 지표 2: 눈과 눈썹 사이의 상대적 거리 (높은 이마/눈썹 판단)
        const leftEyeCenterY = (leftEye[1].y + leftEye[2].y + leftEye[4].y + leftEye[5].y) / 4;
        const leftEyebrowY = (landmarks.getLeftEyeBrow()[0].y + landmarks.getLeftEyeBrow()[1].y + landmarks.getLeftEyeBrow()[2].y + landmarks.getLeftEyeBrow()[3].y + landmarks.getLeftEyeBrow()[4].y) / 5;
        const eyeToEyebrowDistance = leftEyeCenterY - leftEyebrowY;
        const leftEyeHeight = (leftEye[4].y + leftEye[5].y) / 2 - (leftEye[1].y + leftEye[2].y) / 2;
        const normalizedDistance = eyeToEyebrowDistance / leftEyeHeight;
        // [민감도 조절 2] 이 값이 낮을수록 '눈과 눈썹 사이가 멀다'고 판단하기 쉬워집니다. (e.g., 0.8)
        const eyeBrowDistanceThreshold = 1.0; 
        if (normalizedDistance > eyeBrowDistanceThreshold) {
            score++;
        }

        // 최종 판정: 두 지표 중 하나라도 만족하면 '긴 얼굴형(A)'으로 판단
        const faceTypeAB = (score >= 1) ? 'A' : 'B';


        // --- 나머지 분석 로직 ---
        const p1 = jaw[2], p2 = jaw[4], p3 = jaw[8];
        const v1 = { x: p1.x - p2.x, y: p1.y - p2.y };
        const v2 = { x: p3.x - p2.x, y: p3.y - p2.y };
        const dotProduct = v1.x * v2.x + v1.y * v2.y;
        const magnitude1 = Math.sqrt(v1.x**2 + v1.y**2), magnitude2 = Math.sqrt(v2.x**2 + v2.y**2);
        const jawAngle = Math.acos(dotProduct / (magnitude1 * magnitude2)) * (180 / Math.PI);
        const faceTypeCD = (jawAngle < 145) ? 'D' : 'C';

        const leftEyeWidth = leftEye[3].x - leftEye[0].x;
        const step3_eyeShape = (leftEyeWidth / leftEyeHeight < 3.0) ? 'E' : 'F';

        const midEyesX = (leftEye[0].x + rightEye[3].x) / 2;
        const eyeSpreadRatio = Math.abs(midEyesX - landmarks.getNose()[0].x) / faceWidth;
        const step4_featurePosition = (eyeSpreadRatio < 0.03) ? 'A' : 'B';

        const step5_faceRatio = (aspectRatio < 1.2) ? 'C' : 'D';

        const step6_start = (step4_featurePosition === 'A' || faceTypeCD === 'C') ? 'E' : 'F';

        const analysisResult = {
            step1: faceTypeAB,
            step2: faceTypeCD,
            step3: step3_eyeShape,
            step4: step4_featurePosition,
            step5: step5_faceRatio,
            step6: step6_start
        };
        
        displayResults(analysisResult);
        showPage('result-page');

    } catch (error) {
        console.error("사진 분석 중 오류 발생:", error);
        alert("사진을 분석하는 중에 오류가 발생했습니다. 다른 사진으로 시도해보거나, 설문으로 진단하는 방법을 이용해주세요.");
    } finally {
        loader.style.display = 'none';
        analyzeBtn.style.display = 'block';
    }
}
        // 설문 분석 함수
        function analyzeQuiz() {
            const form = document.getElementById('quiz-form');
            const q1 = form.elements['q1'].value;
            const q2 = form.elements['q2'].value;
            const q3 = form.elements['q3'].value;
            const q4 = form.elements['q4'].value;
            
            if (!q1 || !q2 || !q3 || !q4) {
                alert("모든 질문에 답변해주세요!");
                return;
            }

            const quizResult = {
                faceShape: q1,
                jawLine: q2,
                eyeShape: q3,
                featurePosition: q4
            };
            
            displayResults(quizResult, false); // fromPhoto 플래그를 false로 전달
            showPage('result-page');
        }

        // [수정] 결과 표시 함수 (사진 분석 기반 설명 추가)
        function displayResults(analysis, fromPhoto = false) {
            const content = document.getElementById('result-content');
            
            const recommendations = {
                faceShape: {
                    A: "얼굴의 세로 길이를 짧아 보이게 하는 **아치형 눈썹**이나 **일자형 눈썹**을 추천해요. 시선을 분산시켜 얼굴이 짧아 보이는 효과를 줍니다.",
                    B: "얼굴이 답답해 보이지 않도록 **살짝 각을 살린 아치형 눈썹**이 잘 어울려요. 시원하고 세련된 인상을 줄 수 있습니다."
                },
                jawLine: {
                    C: "부드러운 인상을 살려주는 **둥근 아치형 눈썹**이 베스트! 얼굴의 곡선과 조화를 이루어 자연스럽고 여성스러운 느낌을 줍니다.",
                    D: "직선적인 느낌을 중화시켜 줄 **부드러운 곡선 형태의 눈썹**을 추천해요. 너무 각진 눈썹은 인상이 강해 보일 수 있으니 피하는 것이 좋습니다."
                },
                eyeShape: {
                    E: "동그란 눈매를 더 매력적으로 만들어 줄 **부드러운 일자 눈썹**이나 **낮은 아치형 눈썹**으로 청순한 이미지를 연출할 수 있어요.",
                    F: "시원한 눈매와 잘 어울리는 **세련된 각진 아치형 눈썹**을 시도해보세요. 눈썹 산을 살짝 강조하면 이목구비가 더욱 또렷해 보입니다."
                },
                featurePosition: {
                    inner: "눈썹의 시작점을 살짝 뒤에서 시작하고, 눈썹 꼬리를 길게 빼주면 시선이 바깥으로 분산되어 균형 잡힌 인상을 줄 수 있습니다.",
                    outer: "눈썹 앞머리를 조금 더 가깝게 그려주고, 눈썹 길이는 너무 길지 않게 조절하여 이목구비를 모아주는 효과를 줄 수 있습니다."
                }
            };

            const photoBasisText = {
                faceShape: {
                    A: "이마가 넓고 긴 편",
                    B: "이마가 좁고 짧은 편"
                },
                jawLine: {
                    C: "턱선이 둥근 편",
                    D: "턱선이 각지거나 뾰족한 편"
                },
                eyeShape: {
                    E: "눈이 동그란 편",
                    F: "눈이 가로로 긴 편"
                },
                featurePosition: {
                    inner: "이목구비가 모여있는 편",
                    outer: "이목구비가 퍼져있는 편"
                }
            };
            
            let resultHTML = `
                <div class="result-card">
                    <h3>얼굴형 & 턱선</h3>
                    <ul>
                        <li>
                            ${recommendations.faceShape[analysis.faceShape]}
                            ${fromPhoto ? `<span class="photo-basis">(사진 분석: ${photoBasisText.faceShape[analysis.faceShape]})</span>` : ''}
                        </li>
                        <li>
                            ${recommendations.jawLine[analysis.jawLine]}
                            ${fromPhoto ? `<span class="photo-basis">(사진 분석: ${photoBasisText.jawLine[analysis.jawLine]})</span>` : ''}
                        </li>
                    </ul>
                </div>
                <div class="result-card">
                    <h3>눈매 & 이목구비</h3>
                    <ul>
                        <li>
                            ${recommendations.eyeShape[analysis.eyeShape]}
                            ${fromPhoto ? `<span class="photo-basis">(사진 분석: ${photoBasisText.eyeShape[analysis.eyeShape]})</span>` : ''}
                        </li>
                        <li>
                            ${recommendations.featurePosition[analysis.featurePosition]}
                            ${fromPhoto ? `<span class="photo-basis">(사진 분석: ${photoBasisText.featurePosition[analysis.featurePosition]})</span>` : ''}
                        </li>
                    </ul>
                </div>
                <div class="result-card">
                    <h3>종합 추천 💖</h3>
                    <p>위의 특징들을 조합하여, 본인에게 가장 잘 맞는 눈썹 모양을 찾아보세요! 예를 들어, 긴 얼굴형(A)에 둥근 턱(C)이라면 **부드러운 아치형 눈썹**을 기본으로 하되, 너무 높지 않게 그리는 것이 좋습니다.</p>
                </div>
            `;

            content.innerHTML = resultHTML;
        }
    </script>
</body>
</html>
